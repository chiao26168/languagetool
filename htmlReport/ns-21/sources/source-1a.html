


<!DOCTYPE html>
<html id="htmlId">
<head>
  <title>Coverage Report > SpellAndGrammarCheckDialog</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.languagetool.openoffice</a>
</div>

<h1>Coverage Summary for Class: SpellAndGrammarCheckDialog (org.languagetool.openoffice)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">SpellAndGrammarCheckDialog</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/17)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/220)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/313)
  </span>
</td>
</tr>
  <tr>
    <td class="name">SpellAndGrammarCheckDialog$CheckError</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">SpellAndGrammarCheckDialog$ExtensionSpellChecker</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/78)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/107)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">SpellAndGrammarCheckDialog$LtCheckDialog</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/52)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/434)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1096)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">SpellAndGrammarCheckDialog$LtCheckDialog$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/12)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/31)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">SpellAndGrammarCheckDialog$LtCheckDialog$10</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/14)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/27)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">SpellAndGrammarCheckDialog$LtCheckDialog$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/8)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/10)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">SpellAndGrammarCheckDialog$LtCheckDialog$3</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/7)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">SpellAndGrammarCheckDialog$LtCheckDialog$4</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/7)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">SpellAndGrammarCheckDialog$LtCheckDialog$5</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/7)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">SpellAndGrammarCheckDialog$LtCheckDialog$6</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/11)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">SpellAndGrammarCheckDialog$LtCheckDialog$7</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/6)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/18)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">SpellAndGrammarCheckDialog$LtCheckDialog$8</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/6)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">SpellAndGrammarCheckDialog$LtCheckDialog$8$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/12)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/26)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">SpellAndGrammarCheckDialog$LtCheckDialog$8$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/11)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">SpellAndGrammarCheckDialog$LtCheckDialog$9</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/14)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/19)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">SpellAndGrammarCheckDialog$UndoContainer</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/7)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/102)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/804)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1706)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/* LanguageTool, a natural language style checker
&nbsp; * Copyright (C) 2011 Daniel Naber (http://www.danielnaber.de)
&nbsp; *
&nbsp; * This library is free software; you can redistribute it and/or
&nbsp; * modify it under the terms of the GNU Lesser General Public
&nbsp; * License as published by the Free Software Foundation; either
&nbsp; * version 2.1 of the License, or (at your option) any later version.
&nbsp; *
&nbsp; * This library is distributed in the hope that it will be useful,
&nbsp; * but WITHOUT ANY WARRANTY; without even the implied warranty of
&nbsp; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
&nbsp; * Lesser General Public License for more details.
&nbsp; *
&nbsp; * You should have received a copy of the GNU Lesser General Public
&nbsp; * License along with this library; if not, write to the Free Software
&nbsp; * Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301
&nbsp; * USA
&nbsp; */
&nbsp;package org.languagetool.openoffice;
&nbsp;
&nbsp;import java.awt.Color;
&nbsp;import java.awt.Container;
&nbsp;import java.awt.Dimension;
&nbsp;import java.awt.Font;
&nbsp;import java.awt.Frame;
&nbsp;import java.awt.GridBagConstraints;
&nbsp;import java.awt.GridBagLayout;
&nbsp;import java.awt.Image;
&nbsp;import java.awt.Insets;
&nbsp;import java.awt.Point;
&nbsp;import java.awt.Toolkit;
&nbsp;import java.awt.event.ActionEvent;
&nbsp;import java.awt.event.ActionListener;
&nbsp;import java.awt.event.ItemEvent;
&nbsp;import java.awt.event.WindowEvent;
&nbsp;import java.awt.event.WindowFocusListener;
&nbsp;import java.io.File;
&nbsp;import java.io.FileInputStream;
&nbsp;import java.io.FileOutputStream;
&nbsp;import java.io.IOException;
&nbsp;import java.net.URI;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.HashMap;
&nbsp;import java.util.List;
&nbsp;import java.util.Map;
&nbsp;import java.util.ResourceBundle;
&nbsp;import java.util.zip.ZipEntry;
&nbsp;import java.util.zip.ZipInputStream;
&nbsp;import java.util.zip.ZipOutputStream;
&nbsp;
&nbsp;import javax.swing.ButtonGroup;
&nbsp;import javax.swing.JButton;
&nbsp;import javax.swing.JComboBox;
&nbsp;import javax.swing.JDialog;
&nbsp;import javax.swing.JLabel;
&nbsp;import javax.swing.JList;
&nbsp;import javax.swing.JPanel;
&nbsp;import javax.swing.JProgressBar;
&nbsp;import javax.swing.JRadioButton;
&nbsp;import javax.swing.JScrollPane;
&nbsp;import javax.swing.JTextArea;
&nbsp;import javax.swing.JTextPane;
&nbsp;import javax.swing.ListSelectionModel;
&nbsp;import javax.swing.ToolTipManager;
&nbsp;import javax.swing.UIManager;
&nbsp;import javax.swing.event.DocumentEvent;
&nbsp;import javax.swing.event.DocumentListener;
&nbsp;import javax.swing.plaf.basic.BasicComboPopup;
&nbsp;import javax.swing.text.MutableAttributeSet;
&nbsp;import javax.swing.text.StyleConstants;
&nbsp;import javax.swing.text.StyledDocument;
&nbsp;
&nbsp;import org.languagetool.AnalyzedSentence;
&nbsp;import org.languagetool.AnalyzedTokenReadings;
&nbsp;import org.languagetool.JLanguageTool;
&nbsp;import org.languagetool.Language;
&nbsp;import org.languagetool.Languages;
&nbsp;import org.languagetool.JLanguageTool.ParagraphHandling;
&nbsp;import org.languagetool.gui.Configuration;
&nbsp;import org.languagetool.gui.Tools;
&nbsp;import org.languagetool.openoffice.DocumentCache.TextParagraph;
&nbsp;import org.languagetool.openoffice.OfficeDrawTools.UndoMarkupContainer;
&nbsp;import org.languagetool.openoffice.OfficeTools.DocumentType;
&nbsp;import org.languagetool.openoffice.OfficeTools.RemoteCheck;
&nbsp;import org.languagetool.rules.Rule;
&nbsp;import org.languagetool.rules.RuleMatch;
&nbsp;
&nbsp;import com.sun.star.beans.PropertyState;
&nbsp;import com.sun.star.beans.PropertyValue;
&nbsp;import com.sun.star.beans.XPropertySet;
&nbsp;import com.sun.star.lang.Locale;
&nbsp;import com.sun.star.lang.XComponent;
&nbsp;import com.sun.star.lang.XMultiComponentFactory;
&nbsp;import com.sun.star.linguistic2.ProofreadingResult;
&nbsp;import com.sun.star.linguistic2.SingleProofreadingError;
&nbsp;import com.sun.star.text.TextMarkupType;
&nbsp;import com.sun.star.text.XFlatParagraph;
&nbsp;import com.sun.star.text.XMarkingAccess;
&nbsp;import com.sun.star.text.XParagraphCursor;
&nbsp;import com.sun.star.text.XTextCursor;
&nbsp;import com.sun.star.uno.UnoRuntime;
&nbsp;import com.sun.star.uno.XComponentContext;
&nbsp;
&nbsp;/**
&nbsp; * Class defines the spell and grammar check dialog
&nbsp; * @since 5.1
&nbsp; * @author Fred Kruse
&nbsp; */
<b class="nc">&nbsp;public class SpellAndGrammarCheckDialog extends Thread {</b>
&nbsp;  
<b class="nc">&nbsp;  private static boolean debugMode = OfficeTools.DEBUG_MODE_CD;         //  should be false except for testing</b>
&nbsp;
<b class="nc">&nbsp;  private static final ResourceBundle messages = JLanguageTool.getMessageBundle();</b>
<b class="nc">&nbsp;  private static final String spellingError = messages.getString(&quot;desc_spelling&quot;);</b>
&nbsp;  private static final String spellRuleId = &quot;LO_SPELLING_ERROR&quot;;
&nbsp;  
<b class="nc">&nbsp;  private final static String dialogName = messages.getString(&quot;guiOOoCheckDialogName&quot;);</b>
<b class="nc">&nbsp;  private final static String labelLanguage = messages.getString(&quot;textLanguage&quot;);</b>
<b class="nc">&nbsp;  private final static String labelSuggestions = messages.getString(&quot;guiOOosuggestions&quot;); </b>
<b class="nc">&nbsp;  private final static String moreButtonName = messages.getString(&quot;guiMore&quot;); </b>
<b class="nc">&nbsp;  private final static String ignoreButtonName = messages.getString(&quot;guiOOoIgnoreButton&quot;); </b>
<b class="nc">&nbsp;  private final static String ignoreAllButtonName = messages.getString(&quot;guiOOoIgnoreAllButton&quot;); </b>
<b class="nc">&nbsp;  private final static String ignoreRuleButtonName = messages.getString(&quot;guiOOoIgnoreRuleButton&quot;); </b>
<b class="nc">&nbsp;  private final static String deactivateRuleButtonName = messages.getString(&quot;loContextMenuDeactivateRule&quot;); </b>
<b class="nc">&nbsp;  private final static String addToDictionaryName = messages.getString(&quot;guiOOoaddToDictionary&quot;);</b>
<b class="nc">&nbsp;  private final static String changeButtonName = messages.getString(&quot;guiOOoChangeButton&quot;); </b>
<b class="nc">&nbsp;  private final static String changeAllButtonName = messages.getString(&quot;guiOOoChangeAllButton&quot;); </b>
<b class="nc">&nbsp;  private final static String autoCorrectButtonName = messages.getString(&quot;guiOOoAutoCorrectButton&quot;); </b>
<b class="nc">&nbsp;  private final static String helpButtonName = messages.getString(&quot;guiOOoHelpButton&quot;); </b>
<b class="nc">&nbsp;  private final static String optionsButtonName = messages.getString(&quot;guiOOoOptionsButton&quot;); </b>
<b class="nc">&nbsp;  private final static String undoButtonName = messages.getString(&quot;guiUndo&quot;);</b>
<b class="nc">&nbsp;  private final static String closeButtonName = messages.getString(&quot;guiOOoCloseButton&quot;);</b>
<b class="nc">&nbsp;  private final static String changeLanguageList[] = { messages.getString(&quot;guiOOoChangeLanguageRequest&quot;),</b>
<b class="nc">&nbsp;                                                messages.getString(&quot;guiOOoChangeLanguageMatch&quot;),</b>
<b class="nc">&nbsp;                                                messages.getString(&quot;guiOOoChangeLanguageParagraph&quot;) };</b>
<b class="nc">&nbsp;  private final static String languageHelp = messages.getString(&quot;loDialogLanguageHelp&quot;);</b>
<b class="nc">&nbsp;  private final static String changeLanguageHelp = messages.getString(&quot;loDialogChangeLanguageHelp&quot;);</b>
<b class="nc">&nbsp;  private final static String matchDescriptionHelp = messages.getString(&quot;loDialogMatchDescriptionHelp&quot;);</b>
<b class="nc">&nbsp;  private final static String matchParagraphHelp = messages.getString(&quot;loDialogMatchParagraphHelp&quot;);</b>
<b class="nc">&nbsp;  private final static String suggestionsHelp = messages.getString(&quot;loDialogSuggestionsHelp&quot;);</b>
<b class="nc">&nbsp;  private final static String checkTypeHelp = messages.getString(&quot;loDialogCheckTypeHelp&quot;);</b>
<b class="nc">&nbsp;  private final static String helpButtonHelp = messages.getString(&quot;loDialogHelpButtonHelp&quot;); </b>
<b class="nc">&nbsp;  private final static String optionsButtonHelp = messages.getString(&quot;loDialogOptionsButtonHelp&quot;); </b>
<b class="nc">&nbsp;  private final static String undoButtonHelp = messages.getString(&quot;loDialogUndoButtonHelp&quot;);</b>
<b class="nc">&nbsp;  private final static String closeButtonHelp = messages.getString(&quot;loDialogCloseButtonHelp&quot;);</b>
<b class="nc">&nbsp;  private final static String moreButtonHelp = messages.getString(&quot;loDialogMoreButtonHelp&quot;); </b>
<b class="nc">&nbsp;  private final static String ignoreButtonHelp = messages.getString(&quot;loDialogIgnoreButtonHelp&quot;); </b>
<b class="nc">&nbsp;  private final static String ignoreAllButtonHelp = messages.getString(&quot;loDialogIgnoreAllButtonHelp&quot;); </b>
<b class="nc">&nbsp;  private final static String deactivateRuleButtonHelp = messages.getString(&quot;loDialogDeactivateRuleButtonHelp&quot;); </b>
<b class="nc">&nbsp;  private final static String activateRuleButtonHelp = messages.getString(&quot;loDialogActivateRuleButtonHelp&quot;); </b>
<b class="nc">&nbsp;  private final static String addToDictionaryHelp = messages.getString(&quot;loDialogAddToDictionaryButtonHelp&quot;);</b>
<b class="nc">&nbsp;  private final static String changeButtonHelp = messages.getString(&quot;loDialogChangeButtonHelp&quot;); </b>
<b class="nc">&nbsp;  private final static String changeAllButtonHelp = messages.getString(&quot;loDialogChangeAllButtonHelp&quot;); </b>
<b class="nc">&nbsp;  private final static String autoCorrectButtonHelp = messages.getString(&quot;loDialogAutoCorrectButtonHelp&quot;); </b>
<b class="nc">&nbsp;  private final static String checkStatusInitialization = messages.getString(&quot;loCheckStatusInitialization&quot;); </b>
<b class="nc">&nbsp;  private final static String checkStatusCheck = messages.getString(&quot;loCheckStatusCheck&quot;); </b>
<b class="nc">&nbsp;  private final static String labelCheckProgress = messages.getString(&quot;loLabelCheckProgress&quot;); </b>
&nbsp;  
<b class="nc">&nbsp;  private static int nLastFlat = 0;</b>
&nbsp;  
&nbsp;  private final XComponentContext xContext;
&nbsp;  private final MultiDocumentsHandler documents;
&nbsp;  private ExtensionSpellChecker spellChecker;
&nbsp;  
<b class="nc">&nbsp;  private SwJLanguageTool lt = null;</b>
<b class="nc">&nbsp;  private SwJLanguageTool ltSpellChecker = null;</b>
<b class="nc">&nbsp;  private Language lastSpellLanguage = null;</b>
&nbsp;  private Language lastLanguage;
&nbsp;  private Locale locale;
<b class="nc">&nbsp;  private int checkType = 0;</b>
&nbsp;  private DocumentCache docCache;
<b class="nc">&nbsp;  private DocumentType docType = DocumentType.WRITER;</b>
<b class="nc">&nbsp;  private boolean doInit = true;</b>
<b class="nc">&nbsp;  private int dialogX = -1;</b>
<b class="nc">&nbsp;  private int dialogY = -1;</b>
&nbsp;  
<b class="nc">&nbsp;  SpellAndGrammarCheckDialog(XComponentContext xContext, MultiDocumentsHandler documents, Language language) {</b>
<b class="nc">&nbsp;    debugMode = OfficeTools.DEBUG_MODE_CD;</b>
<b class="nc">&nbsp;    this.xContext = xContext;</b>
<b class="nc">&nbsp;    this.documents = documents;</b>
<b class="nc">&nbsp;    lastLanguage = language;</b>
<b class="nc">&nbsp;    locale = LinguisticServices.getLocale(language);</b>
<b class="nc">&nbsp;    if(!documents.javaVersionOkay()) {</b>
&nbsp;      return;
&nbsp;    }
&nbsp;  }
&nbsp;
&nbsp;  /**
&nbsp;   * Initialize LanguageTool to run in LT check dialog and next error function
&nbsp;   */
&nbsp;  private void setLangTool(MultiDocumentsHandler documents, Language language) {
<b class="nc">&nbsp;    documents.setCheckImpressDocument(true);</b>
<b class="nc">&nbsp;    lt = documents.initLanguageTool(language, false);</b>
<b class="nc">&nbsp;    documents.initCheck(lt);</b>
<b class="nc">&nbsp;    if (debugMode) {</b>
<b class="nc">&nbsp;      for (String id : lt.getDisabledRules()) {</b>
<b class="nc">&nbsp;        MessageHandler.printToLogFile(&quot;CheckDialog: setLangTool: After init disabled rule: &quot; + id);</b>
<b class="nc">&nbsp;      }</b>
&nbsp;    }
<b class="nc">&nbsp;    doInit = false;</b>
&nbsp;  }
&nbsp;
&nbsp;  /**
&nbsp;   * opens the LT check dialog for spell and grammar check
&nbsp;   */
&nbsp;  @Override
&nbsp;  public void run() {
&nbsp;    try {
&nbsp;//      SwingUtilities.invokeLater(new Runnable() {
&nbsp;//        public void run() {
&nbsp;//          try {
<b class="nc">&nbsp;            LtCheckDialog checkDialog = new LtCheckDialog(xContext);</b>
<b class="nc">&nbsp;            documents.setLtDialog(checkDialog);</b>
<b class="nc">&nbsp;            checkDialog.show();</b>
&nbsp;//          } catch (Throwable e) {
&nbsp;//            MessageHandler.showError(e);
&nbsp;//          }
&nbsp;//        }
&nbsp;//     });
<b class="nc">&nbsp;    } catch (Throwable e) {</b>
<b class="nc">&nbsp;      MessageHandler.showError(e);</b>
<b class="nc">&nbsp;    }</b>
&nbsp;  }
&nbsp;
&nbsp;  /**
&nbsp;   * Actualize impress/calc document cache
&nbsp;   */
&nbsp;  private void actualizeNonWriterDocumentCache(SingleDocument document) {
<b class="nc">&nbsp;    if (docType != DocumentType.WRITER) {</b>
<b class="nc">&nbsp;      DocumentCache oldCache = new DocumentCache(docCache);</b>
<b class="nc">&nbsp;      docCache.refresh(document, null, null, document.getXComponent(), 7);</b>
<b class="nc">&nbsp;      if (!oldCache.isEmpty()) {</b>
<b class="nc">&nbsp;        boolean isSame = true;</b>
<b class="nc">&nbsp;        if (oldCache.size() != docCache.size()) {</b>
<b class="nc">&nbsp;          isSame = false;</b>
&nbsp;        } else {
<b class="nc">&nbsp;          for (int i = 0; i &lt; docCache.size(); i++) {</b>
<b class="nc">&nbsp;            if (!docCache.getFlatParagraph(i).equals(oldCache.getFlatParagraph(i))) {</b>
<b class="nc">&nbsp;              isSame = false;</b>
<b class="nc">&nbsp;              break;</b>
&nbsp;            }
&nbsp;          }
&nbsp;        }
<b class="nc">&nbsp;        if (!isSame) {</b>
<b class="nc">&nbsp;          document.resetResultCache();</b>
&nbsp;        }
&nbsp;      }
&nbsp;    }
&nbsp;  }
&nbsp;  
&nbsp;  /**
&nbsp;   * Actualize writer document cache
&nbsp;   */
&nbsp;  private void actualizeWriterDocumentCache(SingleDocument document) {
<b class="nc">&nbsp;    if (docType == DocumentType.WRITER) {</b>
<b class="nc">&nbsp;      XComponent xComponent = document.getXComponent();</b>
<b class="nc">&nbsp;      DocumentCache oldCache = new DocumentCache(docCache);</b>
<b class="nc">&nbsp;      docCache.refresh(document, LinguisticServices.getLocale(documents.getConfiguration().getDefaultLanguage()), locale, xComponent, 8);</b>
<b class="nc">&nbsp;      if (!oldCache.isEmpty() &amp;&amp; !docCache.isEmpty()) {</b>
<b class="nc">&nbsp;        if (oldCache.size() != docCache.size()) {</b>
<b class="nc">&nbsp;          int from = 0;</b>
<b class="nc">&nbsp;          int to = 1;</b>
&nbsp;          // to prevent spontaneous recheck of nearly the whole text
&nbsp;          // the change of text contents has to be checked first
&nbsp;          // ignore headers and footers and the change of function inside of them
<b class="nc">&nbsp;          while (from &lt; docCache.size() &amp;&amp; from &lt; oldCache.size() </b>
<b class="nc">&nbsp;              &amp;&amp; (docCache.getNumberOfTextParagraph(from).type == DocumentCache.CURSOR_TYPE_HEADER_FOOTER</b>
<b class="nc">&nbsp;              || docCache.getFlatParagraph(from).equals(oldCache.getFlatParagraph(from)))) {</b>
<b class="nc">&nbsp;            from++;</b>
&nbsp;          }
<b class="nc">&nbsp;          boolean isTextChange = from &lt; docCache.size() &amp;&amp; from &lt; oldCache.size();</b>
<b class="nc">&nbsp;          if (isTextChange) {</b>
&nbsp;            // if change in text is found check the number of text paragraphs which have changed
<b class="nc">&nbsp;            while (to &lt;= docCache.size() &amp;&amp; to &lt;= oldCache.size()</b>
<b class="nc">&nbsp;                &amp;&amp; (docCache.getNumberOfTextParagraph(docCache.size() - to).type == DocumentCache.CURSOR_TYPE_HEADER_FOOTER</b>
<b class="nc">&nbsp;                || docCache.getFlatParagraph(docCache.size() - to).equals(</b>
<b class="nc">&nbsp;                        oldCache.getFlatParagraph(oldCache.size() - to)))) {</b>
<b class="nc">&nbsp;              to++;</b>
&nbsp;            }
<b class="nc">&nbsp;            to = docCache.size() - to;</b>
<b class="nc">&nbsp;            if (to &lt; 0) {</b>
<b class="nc">&nbsp;              to = 0;</b>
&nbsp;            }
&nbsp;          } else {
&nbsp;            // if no change in text is found check the number of flat paragraphs which have changed
<b class="nc">&nbsp;            from = 0;</b>
<b class="nc">&nbsp;            while (from &lt; docCache.size() &amp;&amp; from &lt; oldCache.size()</b>
<b class="nc">&nbsp;                &amp;&amp; (docCache.getNumberOfTextParagraph(from).type != DocumentCache.CURSOR_TYPE_HEADER_FOOTER</b>
<b class="nc">&nbsp;                || docCache.getFlatParagraph(from).equals(oldCache.getFlatParagraph(from)))) {</b>
<b class="nc">&nbsp;              from++;</b>
&nbsp;            }
<b class="nc">&nbsp;            while (to &lt;= docCache.size() &amp;&amp; to &lt;= oldCache.size()</b>
<b class="nc">&nbsp;                &amp;&amp; (docCache.getNumberOfTextParagraph(docCache.size() - to).type != DocumentCache.CURSOR_TYPE_HEADER_FOOTER</b>
<b class="nc">&nbsp;                || docCache.getFlatParagraph(docCache.size() - to).equals(</b>
<b class="nc">&nbsp;                        oldCache.getFlatParagraph(oldCache.size() - to)))) {</b>
<b class="nc">&nbsp;              to++;</b>
&nbsp;            }
<b class="nc">&nbsp;            to = docCache.size() - to;</b>
&nbsp;          }
<b class="nc">&nbsp;          if (debugMode) {</b>
<b class="nc">&nbsp;            MessageHandler.printToLogFile(&quot;CheckDialog: actualizeWriterDocumentCache: Changed paragraphs: from:&quot; + from + &quot;, to: &quot; + to);</b>
&nbsp;          }
<b class="nc">&nbsp;          for (ResultCache cache : document.getParagraphsCache()) {</b>
<b class="nc">&nbsp;            cache.removeAndShift(from, to, oldCache.size(), docCache.size());</b>
<b class="nc">&nbsp;          }</b>
<b class="nc">&nbsp;        } else {</b>
<b class="nc">&nbsp;          for (int i = 0; i &lt; docCache.size(); i++) {</b>
<b class="nc">&nbsp;            if (!docCache.getFlatParagraph(i).equals(oldCache.getFlatParagraph(i))) {</b>
<b class="nc">&nbsp;              for (ResultCache cache : document.getParagraphsCache()) {</b>
<b class="nc">&nbsp;                cache.remove(i);</b>
<b class="nc">&nbsp;              }</b>
&nbsp;            }
&nbsp;          }
&nbsp;        }
&nbsp;      }
&nbsp;    }
&nbsp;  }
&nbsp;  
&nbsp;  /**
&nbsp;   * Get the current document
&nbsp;   * Wait until it is initialized (by LO/OO)
&nbsp;   */
&nbsp;  private SingleDocument getCurrentDocument(boolean actualize) {
<b class="nc">&nbsp;    SingleDocument currentDocument = documents.getCurrentDocument();</b>
<b class="nc">&nbsp;    int nWait = 0;</b>
<b class="nc">&nbsp;    while (currentDocument == null) {</b>
<b class="nc">&nbsp;      if (documents.isNotTextDocument()) {</b>
<b class="nc">&nbsp;        return null;</b>
&nbsp;      }
<b class="nc">&nbsp;      if (nWait &gt; 400) {</b>
<b class="nc">&nbsp;        return null;</b>
&nbsp;      }
<b class="nc">&nbsp;      MessageHandler.printToLogFile(&quot;CheckDialog: getCurrentDocument: Wait: &quot; + ((nWait + 1) * 20));</b>
<b class="nc">&nbsp;      nWait++;</b>
&nbsp;      try {
<b class="nc">&nbsp;        Thread.sleep(20);</b>
<b class="nc">&nbsp;      } catch (InterruptedException e) {</b>
<b class="nc">&nbsp;        MessageHandler.printException(e);</b>
<b class="nc">&nbsp;      }</b>
<b class="nc">&nbsp;      currentDocument = documents.getCurrentDocument();</b>
&nbsp;    }
<b class="nc">&nbsp;    if (currentDocument != null) {</b>
<b class="nc">&nbsp;      docType = currentDocument.getDocumentType();</b>
<b class="nc">&nbsp;      docCache = currentDocument.getDocumentCache();</b>
<b class="nc">&nbsp;      if (docType != DocumentType.WRITER) {</b>
<b class="nc">&nbsp;        actualizeNonWriterDocumentCache(currentDocument);</b>
<b class="nc">&nbsp;      } else if (docCache.size() == 0) {</b>
<b class="nc">&nbsp;        XComponent xComponent = currentDocument.getXComponent();</b>
<b class="nc">&nbsp;        docCache.refresh(currentDocument, LinguisticServices.getLocale(documents.getConfiguration().getDefaultLanguage()), locale, xComponent, 8);</b>
<b class="nc">&nbsp;      } else if (actualize) {</b>
<b class="nc">&nbsp;        actualizeWriterDocumentCache(currentDocument);</b>
&nbsp;      }
&nbsp;    }
<b class="nc">&nbsp;    return currentDocument;</b>
&nbsp;  }
&nbsp;
&nbsp;   /**
&nbsp;   * Find the next error relative to the position of cursor and set the view cursor to the position
&nbsp;   */
&nbsp;  public void nextError() {
&nbsp;    try {
<b class="nc">&nbsp;      SingleDocument document = getCurrentDocument(false);</b>
<b class="nc">&nbsp;      if (document == null || docType != DocumentType.WRITER || !documents.isEnoughHeapSpace()) {</b>
&nbsp;        return;
&nbsp;      }
<b class="nc">&nbsp;      if (docCache == null || docCache.size() &lt;= 0) {</b>
&nbsp;        return;
&nbsp;      }
<b class="nc">&nbsp;      if (spellChecker == null) {</b>
<b class="nc">&nbsp;        spellChecker = new ExtensionSpellChecker();</b>
&nbsp;      }
<b class="nc">&nbsp;      if (lt == null || !documents.isCheckImpressDocument()) {</b>
<b class="nc">&nbsp;        setLangTool(documents, lastLanguage);</b>
&nbsp;      }
<b class="nc">&nbsp;      XComponent xComponent = document.getXComponent();</b>
<b class="nc">&nbsp;      DocumentCursorTools docCursor = new DocumentCursorTools(xComponent);</b>
<b class="nc">&nbsp;      ViewCursorTools viewCursor = new ViewCursorTools(xComponent);</b>
<b class="nc">&nbsp;      int yFlat = getCurrentFlatParagraphNumber(viewCursor, docCache);</b>
<b class="nc">&nbsp;      if (yFlat &lt; 0) {</b>
<b class="nc">&nbsp;        MessageHandler.showClosingInformationDialog(messages.getString(&quot;loNextErrorUnsupported&quot;));</b>
&nbsp;        return;
&nbsp;      }
<b class="nc">&nbsp;      int x = viewCursor.getViewCursorCharacter();</b>
<b class="nc">&nbsp;      while (yFlat &lt; docCache.size()) {</b>
<b class="nc">&nbsp;        CheckError nextError = getNextErrorInParagraph (x, yFlat, document, docCursor, false);</b>
<b class="nc">&nbsp;        if (nextError != null &amp;&amp; setFlatViewCursor(nextError.error.nErrorStart + 1, yFlat, viewCursor, docCache)) {</b>
&nbsp;          return;
&nbsp;        }
<b class="nc">&nbsp;        x = 0;</b>
<b class="nc">&nbsp;        yFlat++;</b>
<b class="nc">&nbsp;      }</b>
<b class="nc">&nbsp;      MessageHandler.showClosingInformationDialog(messages.getString(&quot;guiCheckComplete&quot;));</b>
<b class="nc">&nbsp;  } catch (Throwable t) {</b>
<b class="nc">&nbsp;    MessageHandler.showError(t);</b>
<b class="nc">&nbsp;  }</b>
&nbsp;  }
&nbsp;
&nbsp;  /**
&nbsp;   * get the current number of the flat paragraph related to the position of view cursor
&nbsp;   * the function considers footnotes, headlines, tables, etc. included in the document 
&nbsp;   */
&nbsp;  private int getCurrentFlatParagraphNumber(ViewCursorTools viewCursor, DocumentCache docCache) {
<b class="nc">&nbsp;    TextParagraph textPara = viewCursor.getViewCursorParagraph();</b>
<b class="nc">&nbsp;    if (textPara.type == DocumentCache.CURSOR_TYPE_UNKNOWN) {</b>
<b class="nc">&nbsp;      return -1;</b>
&nbsp;    }
<b class="nc">&nbsp;    nLastFlat = docCache.getFlatParagraphNumber(textPara);</b>
<b class="nc">&nbsp;    return nLastFlat; </b>
&nbsp;  }
&nbsp;
&nbsp;   /**
&nbsp;   * Set the view cursor to text position x, y 
&nbsp;   * y = Paragraph of pure text (no footnotes, tables, etc.)
&nbsp;   * x = number of character in paragraph
&nbsp;   */
&nbsp;  public static void setTextViewCursor(int x, TextParagraph y, ViewCursorTools viewCursor)  {
<b class="nc">&nbsp;    viewCursor.setTextViewCursor(x, y);</b>
&nbsp;  }
&nbsp;
&nbsp;  /**
&nbsp;   * Set the view cursor to position of flat paragraph xFlat, yFlat 
&nbsp;   * y = Flat paragraph of pure text (includes footnotes, tables, etc.)
&nbsp;   * x = number of character in flat paragraph
&nbsp;   */
&nbsp;  private boolean setFlatViewCursor(int xFlat, int yFlat, ViewCursorTools viewCursor, DocumentCache docCache)  {
<b class="nc">&nbsp;    if (yFlat &lt; 0) {</b>
<b class="nc">&nbsp;      return false;</b>
&nbsp;    }
<b class="nc">&nbsp;    TextParagraph para = docCache.getNumberOfTextParagraph(yFlat);</b>
<b class="nc">&nbsp;    viewCursor.setTextViewCursor(xFlat, para);</b>
<b class="nc">&nbsp;    return true;</b>
&nbsp;  }
&nbsp;  
&nbsp;  /**
&nbsp;   * change the text of a paragraph independent of the type of document
&nbsp;   */
&nbsp;  private void changeTextOfParagraph(int nFPara, int nStart, int nLength, String replace, 
&nbsp;      SingleDocument document, ViewCursorTools viewCursor) {
<b class="nc">&nbsp;    String sPara = docCache.getFlatParagraph(nFPara);</b>
<b class="nc">&nbsp;    String sEnd = (nStart + nLength &lt; sPara.length() ? sPara.substring(nStart + nLength) : &quot;&quot;);</b>
<b class="nc">&nbsp;    sPara = sPara.substring(0, nStart) + replace + sEnd;</b>
<b class="nc">&nbsp;    if (debugMode) {</b>
<b class="nc">&nbsp;      MessageHandler.printToLogFile(&quot;CheckDialog: changeTextOfParagraph: set setFlatParagraph: &quot; + sPara);</b>
&nbsp;    }
<b class="nc">&nbsp;    if (docType == DocumentType.IMPRESS) {</b>
<b class="nc">&nbsp;      OfficeDrawTools.changeTextOfParagraph(nFPara, nStart, nLength, replace, document.getXComponent());</b>
<b class="nc">&nbsp;    } else if (docType == DocumentType.CALC) {</b>
<b class="nc">&nbsp;      OfficeSpreadsheetTools.setTextofCell(nFPara, sPara, document.getXComponent());</b>
&nbsp;    } else {
&nbsp;/*      
&nbsp;      TextParagraph tPara = docCache.getNumberOfTextParagraph(nFPara);
&nbsp;      if (tPara.type != DocumentCache.CURSOR_TYPE_UNKNOWN) {
&nbsp;        if (debugMode) {
&nbsp;          MessageHandler.printToLogFile(&quot;CheckDialog: changeTextOfParagraph: nStart = &quot; + nStart 
&nbsp;              + &quot;, nLength = &quot; + nLength + &quot;, replace = &quot; + replace);
&nbsp;          MessageHandler.printToLogFile(&quot;CheckDialog: changeTextOfParagraph: set viewCursor&quot;);
&nbsp;        }
&nbsp;        setTextViewCursor(nStart, tPara, viewCursor);
&nbsp;        if (debugMode) {
&nbsp;          MessageHandler.printToLogFile(&quot;CheckDialog: changeTextOfParagraph: set setViewCursorParagraphText:&quot; + replace);
&nbsp;        }
&nbsp;        nStart = docCache.correctStartPoint(nStart, nFPara);
&nbsp;        viewCursor.setViewCursorParagraphText(nStart, nLength, replace);
&nbsp;        setTextViewCursor(nStart, tPara, viewCursor);
&nbsp;      } else {
&nbsp;*/
<b class="nc">&nbsp;        document.getFlatParagraphTools().changeTextOfParagraph(nFPara, nStart, nLength, replace);</b>
&nbsp;//      }
&nbsp;    }
<b class="nc">&nbsp;    docCache.setFlatParagraph(nFPara, sPara);</b>
<b class="nc">&nbsp;    document.removeResultCache(nFPara);</b>
<b class="nc">&nbsp;    document.removeIgnoredMatch(nFPara, true);</b>
<b class="nc">&nbsp;    if (documents.getConfiguration().useTextLevelQueue() &amp;&amp; !documents.getConfiguration().noBackgroundCheck()) {</b>
<b class="nc">&nbsp;      for (int i = 1; i &lt; documents.getNumMinToCheckParas().size(); i++) {</b>
<b class="nc">&nbsp;        document.addQueueEntry(nFPara, i, documents.getNumMinToCheckParas().get(i), document.getDocID(), false, true);</b>
&nbsp;      }
&nbsp;    }
&nbsp;  }
&nbsp;
&nbsp;  /**
&nbsp;   * Get the first error in the flat paragraph nFPara at or after character position x
&nbsp;   * @throws Throwable 
&nbsp;   */
&nbsp;  private CheckError getNextErrorInParagraph (int x, int nFPara, SingleDocument document, 
&nbsp;      DocumentCursorTools docTools, boolean checkFrames) throws Throwable {
<b class="nc">&nbsp;    if (docCache.isAutomaticGenerated(nFPara)) {</b>
<b class="nc">&nbsp;      return null;</b>
&nbsp;    }
<b class="nc">&nbsp;    String text = docCache.getFlatParagraph(nFPara);</b>
<b class="nc">&nbsp;    locale = docCache.getFlatParagraphLocale(nFPara);</b>
&nbsp;//    MessageHandler.printToLogFile(&quot;CheckDialog: getNextErrorInParagraph(&quot; + nFPara + &quot;, 1): locale: &quot; + (locale == null ? &quot;null&quot; : OfficeTools.localeToString(locale)));
<b class="nc">&nbsp;    if (locale.Language.equals(&quot;zxx&quot;)) { // unknown Language </b>
<b class="nc">&nbsp;      locale = documents.getLocale();</b>
&nbsp;    }
&nbsp;//    MessageHandler.printToLogFile(&quot;CheckDialog: getNextErrorInParagraph(&quot; + nFPara + &quot;, 2): locale: &quot; + (locale == null ? &quot;null&quot; : OfficeTools.localeToString(locale)));
<b class="nc">&nbsp;    int[] footnotePosition = docCache.getFlatParagraphFootnotes(nFPara);</b>
&nbsp;
<b class="nc">&nbsp;    CheckError sError = null;</b>
<b class="nc">&nbsp;    SingleProofreadingError gError = null;</b>
<b class="nc">&nbsp;    if (checkType != 2) {</b>
<b class="nc">&nbsp;      sError = getNextSpellErrorInParagraph (x, nFPara, text, locale, document, docTools);</b>
&nbsp;    }
<b class="nc">&nbsp;    if (checkType != 1 &amp;&amp; (checkFrames || docCache.getParagraphType(nFPara) != DocumentCache.CURSOR_TYPE_SHAPE)) {</b>
<b class="nc">&nbsp;      gError = getNextGrammatikErrorInParagraph(x, nFPara, text, footnotePosition, locale, document);</b>
&nbsp;    }
&nbsp;//    MessageHandler.printToLogFile(&quot;CheckDialog: getNextErrorInParagraph(&quot; + nFPara + &quot;, 3): locale: &quot; + (locale == null ? &quot;null&quot; : OfficeTools.localeToString(locale)));
<b class="nc">&nbsp;    if (sError != null) {</b>
<b class="nc">&nbsp;      if (gError != null &amp;&amp; gError.nErrorStart &lt; sError.error.nErrorStart) {</b>
<b class="nc">&nbsp;        return new CheckError(locale, gError);</b>
&nbsp;      }
<b class="nc">&nbsp;      return sError; </b>
<b class="nc">&nbsp;    } else if (gError != null) {</b>
<b class="nc">&nbsp;      return new CheckError(locale, gError);</b>
&nbsp;    } else {
<b class="nc">&nbsp;      return null;</b>
&nbsp;    }
&nbsp;  }
&nbsp;  
&nbsp;  /**
&nbsp;   * Get the first spelling error in the flat paragraph nPara at or after character position x
&nbsp;   * @throws Throwable 
&nbsp;   */
&nbsp;  private CheckError getNextSpellErrorInParagraph (int x, int nPara, String text, Locale locale, SingleDocument document, 
&nbsp;      DocumentCursorTools docTools) throws Throwable {
&nbsp;    List&lt;CheckError&gt; spellErrors;
&nbsp;/*
&nbsp;    if (lt.isRemote()) {
&nbsp;      spellErrors = getRemoteSpellErrorInParagraph(nPara, text, locale, document);
&nbsp;    } else {
&nbsp;      spellErrors = spellChecker.getSpellErrors(nPara, text, locale, document);
&nbsp;    }
&nbsp;*/
<b class="nc">&nbsp;    spellErrors = getSpellErrorInParagraph(nPara, text, locale, document, docTools);</b>
<b class="nc">&nbsp;    if (spellErrors != null) {</b>
<b class="nc">&nbsp;      for (CheckError spellError : spellErrors) {</b>
<b class="nc">&nbsp;        if (spellError.error != null &amp;&amp; spellError.error.nErrorStart &gt;= x) {</b>
<b class="nc">&nbsp;          if (debugMode) {</b>
<b class="nc">&nbsp;            MessageHandler.printToLogFile(&quot;CheckDialog: getNextSpellErrorInParagraph: Next Error: ErrorStart == &quot; + spellError.error.nErrorStart + &quot;, x: &quot; + x);</b>
&nbsp;          }
<b class="nc">&nbsp;          return spellError;</b>
&nbsp;        }
<b class="nc">&nbsp;      }</b>
&nbsp;    }
<b class="nc">&nbsp;    return null;</b>
&nbsp;  }
&nbsp;  
&nbsp;  /**
&nbsp;   * Get the first grammatical error in the flat paragraph y at or after character position x
&nbsp;   */
&nbsp;  private List&lt;CheckError&gt; getSpellErrorInParagraph(int nPara, String text, Locale locale, SingleDocument document, 
&nbsp;      DocumentCursorTools docTools) throws Throwable {
<b class="nc">&nbsp;    if (text == null || text.isEmpty()) {</b>
<b class="nc">&nbsp;      return null;</b>
&nbsp;    }
<b class="nc">&nbsp;    List&lt;CheckError&gt; errorArray = new ArrayList&lt;CheckError&gt;();</b>
&nbsp;    List&lt;RuleMatch&gt; matches;
<b class="nc">&nbsp;    if (lt.isRemote()) {</b>
<b class="nc">&nbsp;      matches = lt.check(text, true, ParagraphHandling.ONLYNONPARA, RemoteCheck.ONLY_SPELL);</b>
&nbsp;    } else {
<b class="nc">&nbsp;      Language language = documents.getLanguage(locale);</b>
<b class="nc">&nbsp;      if (ltSpellChecker == null || lastLanguage == null || !lastSpellLanguage.equals(language)) {</b>
<b class="nc">&nbsp;        lastSpellLanguage = language;</b>
<b class="nc">&nbsp;        Configuration config = documents.getConfiguration();</b>
<b class="nc">&nbsp;        ltSpellChecker = new SwJLanguageTool(language, config.getMotherTongue(), null, config, null, false);</b>
<b class="nc">&nbsp;        for (Rule rule : ltSpellChecker.getAllActiveOfficeRules()) {</b>
<b class="nc">&nbsp;          if (!rule.isDictionaryBasedSpellingRule()) {</b>
<b class="nc">&nbsp;            ltSpellChecker.disableRule(rule.getId());</b>
&nbsp;          }
<b class="nc">&nbsp;        }</b>
&nbsp;      }
<b class="nc">&nbsp;      matches = ltSpellChecker.check(text, true, ParagraphHandling.ONLYNONPARA, RemoteCheck.ONLY_SPELL);</b>
&nbsp;    }
<b class="nc">&nbsp;    for (RuleMatch match : matches) {</b>
<b class="nc">&nbsp;      String word = text.substring(match.getFromPos(), match.getToPos());</b>
<b class="nc">&nbsp;      if (!document.isIgnoreOnce(match.getFromPos(), match.getToPos(), nPara, spellRuleId)</b>
<b class="nc">&nbsp;          &amp;&amp; !spellChecker.getLinguServices().isCorrectSpell(word, locale) </b>
<b class="nc">&nbsp;          &amp;&amp; !docTools.isProtectedCharacter(docCache.getNumberOfTextParagraph(nPara), (short) match.getFromPos())) {</b>
<b class="nc">&nbsp;        SingleProofreadingError aError = new SingleProofreadingError();</b>
<b class="nc">&nbsp;        aError.nErrorType = TextMarkupType.SPELLCHECK;</b>
<b class="nc">&nbsp;        aError.aFullComment = JLanguageTool.getMessageBundle().getString(&quot;desc_spelling&quot;);</b>
<b class="nc">&nbsp;        aError.aShortComment = aError.aFullComment;</b>
<b class="nc">&nbsp;        aError.nErrorStart = match.getFromPos();</b>
<b class="nc">&nbsp;        aError.nErrorLength = match.getToPos() - match.getFromPos();</b>
<b class="nc">&nbsp;        aError.aRuleIdentifier = spellRuleId;</b>
<b class="nc">&nbsp;        PropertyValue[] propertyValues = new PropertyValue[1];</b>
<b class="nc">&nbsp;        int ucolor = Color.RED.getRGB() &amp; 0xFFFFFF;</b>
<b class="nc">&nbsp;        propertyValues[0] = new PropertyValue(&quot;LineColor&quot;, -1, ucolor, PropertyState.DIRECT_VALUE);</b>
<b class="nc">&nbsp;        aError.aProperties = propertyValues;</b>
<b class="nc">&nbsp;        errorArray.add(new CheckError(locale, aError));</b>
<b class="nc">&nbsp;        if (match.getSuggestedReplacements() != null) {</b>
<b class="nc">&nbsp;          aError.aSuggestions = match.getSuggestedReplacements().toArray(new String[match.getSuggestedReplacements().size()]);</b>
&nbsp;        } else {
<b class="nc">&nbsp;          aError.aSuggestions = new String[0];</b>
&nbsp;        }
&nbsp;      }
<b class="nc">&nbsp;    }</b>
<b class="nc">&nbsp;    return errorArray;</b>
&nbsp;  }
&nbsp;  
&nbsp;  /**
&nbsp;   * Get the first grammatical error in the flat paragraph y at or after character position x
&nbsp;   */
&nbsp;  SingleProofreadingError getNextGrammatikErrorInParagraph(int x, int nFPara, String text, int[] footnotePosition, 
&nbsp;      Locale locale, SingleDocument document) throws Throwable {
<b class="nc">&nbsp;    if (text == null || text.isEmpty() || x &gt;= text.length() || !documents.hasLocale(locale)) {</b>
<b class="nc">&nbsp;      return null;</b>
&nbsp;    }
<b class="nc">&nbsp;    PropertyValue[] propertyValues = { new PropertyValue(&quot;FootnotePositions&quot;, -1, footnotePosition, PropertyState.DIRECT_VALUE) };</b>
<b class="nc">&nbsp;    ProofreadingResult paRes = new ProofreadingResult();</b>
<b class="nc">&nbsp;    paRes.nStartOfSentencePosition = 0;</b>
<b class="nc">&nbsp;    paRes.nStartOfNextSentencePosition = 0;</b>
<b class="nc">&nbsp;    paRes.nBehindEndOfSentencePosition = paRes.nStartOfNextSentencePosition;</b>
<b class="nc">&nbsp;    paRes.xProofreader = null;</b>
<b class="nc">&nbsp;    paRes.aLocale = locale;</b>
<b class="nc">&nbsp;    paRes.aDocumentIdentifier = document.getDocID();</b>
<b class="nc">&nbsp;    paRes.aText = text;</b>
<b class="nc">&nbsp;    paRes.aProperties = propertyValues;</b>
<b class="nc">&nbsp;    paRes.aErrors = null;</b>
<b class="nc">&nbsp;    Language langForShortName = documents.getLanguage(locale);</b>
<b class="nc">&nbsp;    if (doInit || !langForShortName.equals(lastLanguage) || !documents.isCheckImpressDocument()) {</b>
<b class="nc">&nbsp;      lastLanguage = langForShortName;</b>
<b class="nc">&nbsp;      setLangTool(documents, lastLanguage);</b>
<b class="nc">&nbsp;      document.removeResultCache(nFPara);</b>
&nbsp;    }
<b class="nc">&nbsp;    int lastSentenceStart = -1;</b>
<b class="nc">&nbsp;    while (paRes.nStartOfNextSentencePosition &lt; text.length() &amp;&amp; paRes.nStartOfNextSentencePosition != lastSentenceStart) {</b>
<b class="nc">&nbsp;      lastSentenceStart = paRes.nStartOfNextSentencePosition;</b>
<b class="nc">&nbsp;      paRes.nStartOfSentencePosition = paRes.nStartOfNextSentencePosition;</b>
<b class="nc">&nbsp;      paRes.nStartOfNextSentencePosition = text.length();</b>
<b class="nc">&nbsp;      paRes.nBehindEndOfSentencePosition = paRes.nStartOfNextSentencePosition;</b>
<b class="nc">&nbsp;      if (debugMode) {</b>
<b class="nc">&nbsp;        for (String id : lt.getDisabledRules()) {</b>
<b class="nc">&nbsp;          MessageHandler.printToLogFile(&quot;CheckDialog: getNextGrammatikErrorInParagraph: Dialog disabled rule: &quot; + id);</b>
<b class="nc">&nbsp;        }</b>
&nbsp;      }
<b class="nc">&nbsp;      paRes = document.getCheckResults(text, locale, paRes, propertyValues, false, lt, nFPara);</b>
<b class="nc">&nbsp;      if (paRes.aErrors != null) {</b>
<b class="nc">&nbsp;        if (debugMode) {</b>
<b class="nc">&nbsp;          MessageHandler.printToLogFile(&quot;CheckDialog: getNextGrammatikErrorInParagraph: Number of Errors = &quot; </b>
&nbsp;              + paRes.aErrors.length + &quot;, Paragraph: &quot; + nFPara + &quot;, Next Position: &quot; + paRes.nStartOfNextSentencePosition
<b class="nc">&nbsp;              + &quot;, Text.lenth: &quot; + text.length());</b>
&nbsp;        }
<b class="nc">&nbsp;        for (SingleProofreadingError error : paRes.aErrors) {</b>
<b class="nc">&nbsp;          if (debugMode) {</b>
<b class="nc">&nbsp;            MessageHandler.printToLogFile(&quot;CheckDialog: getNextGrammatikErrorInParagraph: Start: &quot; + error.nErrorStart + &quot;, ID: &quot; + error.aRuleIdentifier);</b>
&nbsp;          }
<b class="nc">&nbsp;          if (error.nErrorStart &gt;= x) {</b>
<b class="nc">&nbsp;            return error;</b>
&nbsp;          }        
&nbsp;        }
&nbsp;      }
&nbsp;    }
<b class="nc">&nbsp;    return null;</b>
&nbsp;  }
&nbsp;  
&nbsp;  /** 
&nbsp;   * Class for spell checking in LT check dialog
&nbsp;   * The LO/OO spell checker is used
&nbsp;   */
&nbsp;  private class ExtensionSpellChecker {
&nbsp;
&nbsp;    private LinguisticServices linguServices;
&nbsp;     
<b class="nc">&nbsp;    ExtensionSpellChecker() {</b>
<b class="nc">&nbsp;      linguServices = new LinguisticServices(xContext);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * get a list of all spelling errors of the flat paragraph nPara
&nbsp;     */
&nbsp;    public List&lt;CheckError&gt; getSpellErrors(int nPara, String text, Locale lang, SingleDocument document) throws Throwable {
&nbsp;      try {
<b class="nc">&nbsp;        List&lt;CheckError&gt; errorArray = new ArrayList&lt;CheckError&gt;();</b>
<b class="nc">&nbsp;        if (document == null) {</b>
<b class="nc">&nbsp;          return null;</b>
&nbsp;        }
<b class="nc">&nbsp;        XFlatParagraph xFlatPara = null;</b>
<b class="nc">&nbsp;        if (docType == DocumentType.WRITER) {</b>
<b class="nc">&nbsp;          xFlatPara = document.getFlatParagraphTools().getFlatParagraphAt(nPara);</b>
<b class="nc">&nbsp;          if (xFlatPara == null) {</b>
<b class="nc">&nbsp;            return null;</b>
&nbsp;          }
&nbsp;        }
<b class="nc">&nbsp;        Locale locale = null;</b>
<b class="nc">&nbsp;        AnalyzedSentence analyzedSentence = lt.getAnalyzedSentence(text);</b>
<b class="nc">&nbsp;        AnalyzedTokenReadings[] tokens = analyzedSentence.getTokensWithoutWhitespace();</b>
<b class="nc">&nbsp;        for (int i = 0; i &lt; tokens.length; i++) {</b>
<b class="nc">&nbsp;          AnalyzedTokenReadings token = tokens[i];</b>
<b class="nc">&nbsp;          String sToken = token.getToken();</b>
<b class="nc">&nbsp;          if (!token.isNonWord()) {</b>
<b class="nc">&nbsp;            int nStart = token.getStartPos();</b>
<b class="nc">&nbsp;            int nEnd = token.getEndPos();</b>
<b class="nc">&nbsp;            if (i &lt; tokens.length - 1) {</b>
<b class="nc">&nbsp;              if (tokens[i + 1].getToken().equals(&quot;.&quot;)) {</b>
<b class="nc">&nbsp;                sToken += &quot;.&quot;;</b>
&nbsp;              } else { 
<b class="nc">&nbsp;                String nextToken = tokens[i + 1].getToken();</b>
<b class="nc">&nbsp;                boolean shouldComposed = nextToken.length() &gt; 1 </b>
<b class="nc">&nbsp;                    &amp;&amp; (nextToken.charAt(0) == &#39;&#39; || nextToken.charAt(0) == &#39;\&#39;&#39;</b>
<b class="nc">&nbsp;                    || nextToken.startsWith(&quot;n&quot;) || nextToken.startsWith(&quot;n&#39;&quot;));</b>
<b class="nc">&nbsp;                if (shouldComposed) {</b>
<b class="nc">&nbsp;                  sToken += nextToken;</b>
<b class="nc">&nbsp;                  nEnd = tokens[i + 1].getEndPos();</b>
<b class="nc">&nbsp;                  i++;</b>
&nbsp;                }
&nbsp;              }
&nbsp;            }
<b class="nc">&nbsp;            if (sToken.length() &gt; 1) {</b>
<b class="nc">&nbsp;              if (xFlatPara != null) {</b>
<b class="nc">&nbsp;                locale = xFlatPara.getLanguageOfText(nStart, nEnd - nStart);</b>
&nbsp;              }
<b class="nc">&nbsp;              if (locale == null) {</b>
<b class="nc">&nbsp;                locale = lang;</b>
&nbsp;              }
<b class="nc">&nbsp;              if (!linguServices.isCorrectSpell(sToken, locale)) {</b>
<b class="nc">&nbsp;                SingleProofreadingError aError = new SingleProofreadingError();</b>
<b class="nc">&nbsp;                if (debugMode) {</b>
<b class="nc">&nbsp;                  MessageHandler.printToLogFile(&quot;CheckDialog: getSpellErrors: Spell Error: Word: &quot; + sToken </b>
<b class="nc">&nbsp;                      + &quot;, Start: &quot; + nStart + &quot;, End: &quot; + nEnd + &quot;, Token(&quot; + i + &quot;): &quot; + tokens[i].getToken()</b>
<b class="nc">&nbsp;                      + (i &lt; tokens.length - 1 ? (&quot;, Token(&quot; + (i + 1) + &quot;): &quot; + tokens[i + 1].getToken()) : &quot;&quot;));</b>
&nbsp;                }
<b class="nc">&nbsp;                if (!document.isIgnoreOnce(nStart, nEnd, nPara, spellRuleId)) {</b>
<b class="nc">&nbsp;                  aError.nErrorType = TextMarkupType.SPELLCHECK;</b>
<b class="nc">&nbsp;                  aError.aFullComment = spellingError;</b>
<b class="nc">&nbsp;                  aError.aShortComment = aError.aFullComment;</b>
<b class="nc">&nbsp;                  aError.nErrorStart = nStart;</b>
<b class="nc">&nbsp;                  aError.nErrorLength = nEnd - nStart;</b>
<b class="nc">&nbsp;                  aError.aRuleIdentifier = spellRuleId;</b>
<b class="nc">&nbsp;                  PropertyValue[] propertyValues = new PropertyValue[1];</b>
<b class="nc">&nbsp;                  int ucolor = Color.RED.getRGB() &amp; 0xFFFFFF;</b>
<b class="nc">&nbsp;                  propertyValues[0] = new PropertyValue(&quot;LineColor&quot;, -1, ucolor, PropertyState.DIRECT_VALUE);</b>
<b class="nc">&nbsp;                  aError.aProperties = propertyValues;</b>
<b class="nc">&nbsp;                  errorArray.add(new CheckError(locale, aError));</b>
<b class="nc">&nbsp;                  String[] alternatives = linguServices.getSpellAlternatives(token.getToken(), locale);</b>
<b class="nc">&nbsp;                  if (alternatives != null) {</b>
<b class="nc">&nbsp;                    aError.aSuggestions = alternatives;</b>
&nbsp;                  } else {
<b class="nc">&nbsp;                    aError.aSuggestions = new String[0];</b>
&nbsp;                  }
&nbsp;                }
&nbsp;              }
&nbsp;            }
&nbsp;          }
&nbsp;        }
<b class="nc">&nbsp;        return errorArray;</b>
<b class="nc">&nbsp;      } catch (Throwable t) {</b>
<b class="nc">&nbsp;        MessageHandler.showError(t);</b>
&nbsp;      }
<b class="nc">&nbsp;      return null;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * replaces all words that matches &#39;word&#39; with the string &#39;replace&#39;
&nbsp;     * gives back a map of positions where a replace was done (for undo function)
&nbsp;     */
&nbsp;    public Map&lt;Integer, List&lt;Integer&gt;&gt; replaceAllWordsInText(String word, String replace, 
&nbsp;        DocumentCursorTools cursorTools, SingleDocument document, ViewCursorTools viewCursor) {
<b class="nc">&nbsp;      if (word == null || replace == null || word.isEmpty() || replace.isEmpty() || word.equals(replace)) {</b>
<b class="nc">&nbsp;        return null;</b>
&nbsp;      }
<b class="nc">&nbsp;      Map&lt;Integer, List&lt;Integer&gt;&gt; replacePoints = new HashMap&lt;Integer, List&lt;Integer&gt;&gt;();</b>
&nbsp;      try {
<b class="nc">&nbsp;        int xVC = 0;</b>
<b class="nc">&nbsp;        TextParagraph yVC = null;</b>
<b class="nc">&nbsp;        if (docType == DocumentType.WRITER) {</b>
<b class="nc">&nbsp;          yVC = viewCursor.getViewCursorParagraph();</b>
<b class="nc">&nbsp;          xVC = viewCursor.getViewCursorCharacter();</b>
&nbsp;        }
<b class="nc">&nbsp;        for (int n = 0; n &lt; docCache.size(); n++) {</b>
<b class="nc">&nbsp;          if (lt.isRemote()) {</b>
<b class="nc">&nbsp;            String text = docCache.getFlatParagraph(n);</b>
<b class="nc">&nbsp;            List&lt;RuleMatch&gt; matches = lt.check(text, true, ParagraphHandling.ONLYNONPARA, RemoteCheck.ONLY_SPELL);</b>
<b class="nc">&nbsp;            for (RuleMatch match : matches) {</b>
&nbsp;              List&lt;Integer&gt; x;
<b class="nc">&nbsp;              String matchWord = text.substring(match.getFromPos(), match.getToPos());</b>
<b class="nc">&nbsp;              if (matchWord.equals(word)) {</b>
<b class="nc">&nbsp;                changeTextOfParagraph(n, match.getFromPos(), word.length(), replace, document, viewCursor);</b>
<b class="nc">&nbsp;                if (replacePoints.containsKey(n)) {</b>
<b class="nc">&nbsp;                  x = replacePoints.get(n);</b>
&nbsp;                } else {
<b class="nc">&nbsp;                  x = new ArrayList&lt;Integer&gt;();</b>
&nbsp;                }
<b class="nc">&nbsp;                x.add(0, match.getFromPos());</b>
<b class="nc">&nbsp;                replacePoints.put(n, x);</b>
<b class="nc">&nbsp;                if (debugMode) {</b>
<b class="nc">&nbsp;                  MessageHandler.printToLogFile(&quot;CheckDialog: replaceAllWordsInText: add change undo: y = &quot; + n + &quot;, NumX = &quot; + replacePoints.get(n).size());</b>
&nbsp;                }
&nbsp;              }
<b class="nc">&nbsp;            }</b>
<b class="nc">&nbsp;          } else {</b>
<b class="nc">&nbsp;            AnalyzedSentence analyzedSentence = lt.getAnalyzedSentence(docCache.getFlatParagraph(n));</b>
<b class="nc">&nbsp;            AnalyzedTokenReadings[] tokens = analyzedSentence.getTokensWithoutWhitespace();</b>
<b class="nc">&nbsp;            for (int i = tokens.length - 1; i &gt;= 0 ; i--) {</b>
&nbsp;              List&lt;Integer&gt; x ;
<b class="nc">&nbsp;              if (tokens[i].getToken().equals(word)) {</b>
<b class="nc">&nbsp;                if (debugMode) {</b>
<b class="nc">&nbsp;                  MessageHandler.printToLogFile(&quot;CheckDialog: replaceAllWordsInText: change paragraph: y = &quot; + n + &quot;, word = &quot; + tokens[i].getToken()  + &quot;, replace = &quot; + word);</b>
&nbsp;                }
<b class="nc">&nbsp;                changeTextOfParagraph(n, tokens[i].getStartPos(), word.length(), replace, document, viewCursor);</b>
<b class="nc">&nbsp;                if (replacePoints.containsKey(n)) {</b>
<b class="nc">&nbsp;                  x = replacePoints.get(n);</b>
&nbsp;                } else {
<b class="nc">&nbsp;                  x = new ArrayList&lt;Integer&gt;();</b>
&nbsp;                }
<b class="nc">&nbsp;                x.add(0, tokens[i].getStartPos());</b>
<b class="nc">&nbsp;                replacePoints.put(n, x);</b>
<b class="nc">&nbsp;                if (debugMode) {</b>
<b class="nc">&nbsp;                  MessageHandler.printToLogFile(&quot;CheckDialog: replaceAllWordsInText: add change undo: y = &quot; + n + &quot;, NumX = &quot; + replacePoints.get(n).size());</b>
&nbsp;                }
&nbsp;              }
&nbsp;            }
&nbsp;          }
&nbsp;        }
<b class="nc">&nbsp;        if (docType == DocumentType.WRITER) {</b>
<b class="nc">&nbsp;          setTextViewCursor(xVC, yVC, viewCursor);</b>
&nbsp;        }
<b class="nc">&nbsp;      } catch (Throwable t) {</b>
<b class="nc">&nbsp;        MessageHandler.showError(t);</b>
<b class="nc">&nbsp;      }</b>
<b class="nc">&nbsp;      return replacePoints;</b>
&nbsp;    }
&nbsp;    
&nbsp;    public LinguisticServices getLinguServices() {
<b class="nc">&nbsp;      return linguServices;</b>
&nbsp;    }
&nbsp;
&nbsp;  }
&nbsp;
&nbsp;  /**
&nbsp;   * class to store the information for undo
&nbsp;   */
&nbsp;  private class UndoContainer {
&nbsp;    public int x;
&nbsp;    public int y;
&nbsp;    public String action;
&nbsp;    public String ruleId;
&nbsp;    public String word;
&nbsp;    public Map&lt;Integer, List&lt;Integer&gt;&gt; orgParas;
&nbsp;    
<b class="nc">&nbsp;    UndoContainer(int x, int y, String action, String ruleId, String word, Map&lt;Integer, List&lt;Integer&gt;&gt; orgParas) {</b>
<b class="nc">&nbsp;      this.x = x;</b>
<b class="nc">&nbsp;      this.y = y;</b>
<b class="nc">&nbsp;      this.action = action;</b>
<b class="nc">&nbsp;      this.ruleId = ruleId;</b>
<b class="nc">&nbsp;      this.orgParas = orgParas;</b>
<b class="nc">&nbsp;      this.word = word;</b>
&nbsp;    }
&nbsp;  }
&nbsp;
&nbsp;  /**
&nbsp;   * class contains the SingleProofreadingError and the locale of the match
&nbsp;   */
&nbsp;  private class CheckError {
&nbsp;    public Locale locale;
&nbsp;    public SingleProofreadingError error;
&nbsp;    
<b class="nc">&nbsp;    CheckError(Locale locale, SingleProofreadingError error) {</b>
<b class="nc">&nbsp;      this.locale = locale;</b>
<b class="nc">&nbsp;      this.error = error;</b>
&nbsp;    }
&nbsp;  }
&nbsp;  
&nbsp;  /**
&nbsp;   * Class for dialog to check text for spell and grammar errors
&nbsp;   */
<b class="nc">&nbsp;  public class LtCheckDialog implements ActionListener {</b>
&nbsp;    private final static String ACORR_PREFIX = &quot;acor_&quot;;
&nbsp;    private final static String ACORR_SUFFIX = &quot;.dat&quot;;
&nbsp;    private final static int maxUndos = 50;
&nbsp;    private final static int toolTipWidth = 300;
&nbsp;    
&nbsp;    private final static int dialogWidth = 640;
&nbsp;    private final static int dialogHeight = 525;
&nbsp;
&nbsp;    private UndoMarkupContainer undoMarkup;
&nbsp;
&nbsp;    private Color defaultForeground;
&nbsp;
&nbsp;    private final JDialog dialog;
&nbsp;    private final Container contentPane;
&nbsp;    private final JLabel languageLabel;
&nbsp;    private final JComboBox&lt;String&gt; language;
&nbsp;    private final JComboBox&lt;String&gt; changeLanguage; 
&nbsp;    private final JTextArea errorDescription;
&nbsp;    private final JTextPane sentenceIncludeError;
&nbsp;    private final JLabel suggestionsLabel;
&nbsp;    private final JList&lt;String&gt; suggestions;
&nbsp;    private final JLabel checkTypeLabel;
&nbsp;    private final JLabel checkProgressLabel;
&nbsp;    private final ButtonGroup checkTypeGroup;
&nbsp;    private final JRadioButton[] checkTypeButtons;
&nbsp;    private final JButton more; 
&nbsp;    private final JButton ignoreOnce; 
&nbsp;    private final JButton ignoreAll; 
&nbsp;    private final JButton deactivateRule;
&nbsp;    private final JComboBox&lt;String&gt; addToDictionary; 
&nbsp;    private final JComboBox&lt;String&gt; activateRule; 
&nbsp;    private final JButton change; 
&nbsp;    private final JButton changeAll; 
&nbsp;    private final JButton autoCorrect; 
&nbsp;    private final JButton help; 
&nbsp;    private final JButton options; 
&nbsp;    private final JButton undo; 
&nbsp;    private final JButton close;
&nbsp;    private JProgressBar checkProgress;
&nbsp;    private final Image ltImage;
&nbsp;    private final List&lt;UndoContainer&gt; undoList;
&nbsp;    
&nbsp;    private SingleDocument currentDocument;
&nbsp;    private ViewCursorTools viewCursor;
&nbsp;    private SingleProofreadingError error;
&nbsp;    String docId;
&nbsp;    private String[] userDictionaries;
&nbsp;    private String informationUrl;
<b class="nc">&nbsp;    private String lastLang = new String();</b>
&nbsp;    private String endOfDokumentMessage;
<b class="nc">&nbsp;    private int x = 0;</b>
<b class="nc">&nbsp;    private int y = 0;  //  current flat Paragraph</b>
<b class="nc">&nbsp;    private int startOfRange = -1;</b>
<b class="nc">&nbsp;    private int endOfRange = -1;</b>
<b class="nc">&nbsp;    private int lastPara = -1;</b>
<b class="nc">&nbsp;    private int lastX = 0;</b>
<b class="nc">&nbsp;    private int lastY = -1;</b>
<b class="nc">&nbsp;    private boolean isSpellError = false;</b>
<b class="nc">&nbsp;    private boolean focusLost = false;</b>
<b class="nc">&nbsp;    private boolean blockSentenceError = true;</b>
<b class="nc">&nbsp;    private boolean atWork = false;</b>
&nbsp;
&nbsp;    private String wrongWord;
&nbsp;    private Locale locale;
&nbsp;    /**
&nbsp;     * the constructor of the class creates all elements of the dialog
&nbsp;     */
<b class="nc">&nbsp;    public LtCheckDialog(XComponentContext xContext) {</b>
<b class="nc">&nbsp;      ltImage = OfficeTools.getLtImage();</b>
<b class="nc">&nbsp;      if (!documents.isJavaLookAndFeelSet()) {</b>
<b class="nc">&nbsp;        documents.setJavaLookAndFeel();</b>
&nbsp;      }
<b class="nc">&nbsp;      undoList = new ArrayList&lt;UndoContainer&gt;();</b>
&nbsp;
<b class="nc">&nbsp;      dialog = new JDialog();</b>
<b class="nc">&nbsp;      contentPane = dialog.getContentPane();</b>
<b class="nc">&nbsp;      languageLabel = new JLabel(labelLanguage);</b>
<b class="nc">&nbsp;      changeLanguage = new JComboBox&lt;String&gt; (changeLanguageList);</b>
<b class="nc">&nbsp;      language = new JComboBox&lt;String&gt;(getPossibleLanguages());</b>
<b class="nc">&nbsp;      errorDescription = new JTextArea();</b>
<b class="nc">&nbsp;      sentenceIncludeError = new JTextPane();</b>
<b class="nc">&nbsp;      suggestionsLabel = new JLabel(labelSuggestions);</b>
<b class="nc">&nbsp;      suggestions = new JList&lt;String&gt;();</b>
<b class="nc">&nbsp;      checkTypeLabel = new JLabel(Tools.getLabel(messages.getString(&quot;guiOOoCheckTypeLabel&quot;)));</b>
<b class="nc">&nbsp;      checkTypeButtons = new JRadioButton[3];</b>
<b class="nc">&nbsp;      checkTypeGroup = new ButtonGroup();</b>
<b class="nc">&nbsp;      help = new JButton (helpButtonName);</b>
<b class="nc">&nbsp;      options = new JButton (optionsButtonName);</b>
<b class="nc">&nbsp;      undo = new JButton (undoButtonName);</b>
<b class="nc">&nbsp;      close = new JButton (closeButtonName);</b>
<b class="nc">&nbsp;      more = new JButton (moreButtonName);</b>
<b class="nc">&nbsp;      ignoreOnce = new JButton (ignoreButtonName);</b>
<b class="nc">&nbsp;      ignoreAll = new JButton (ignoreAllButtonName);</b>
<b class="nc">&nbsp;      deactivateRule = new JButton (deactivateRuleButtonName);</b>
<b class="nc">&nbsp;      addToDictionary = new JComboBox&lt;String&gt; ();</b>
<b class="nc">&nbsp;      change = new JButton (changeButtonName);</b>
<b class="nc">&nbsp;      changeAll = new JButton (changeAllButtonName);</b>
<b class="nc">&nbsp;      autoCorrect = new JButton (autoCorrectButtonName);</b>
<b class="nc">&nbsp;      activateRule = new JComboBox&lt;String&gt; ();</b>
<b class="nc">&nbsp;      checkProgressLabel = new JLabel(labelCheckProgress);</b>
<b class="nc">&nbsp;      checkProgress = new JProgressBar(0, 100);</b>
&nbsp;
&nbsp;      try {
<b class="nc">&nbsp;        if (debugMode) {</b>
<b class="nc">&nbsp;          MessageHandler.printToLogFile(&quot;CheckDialog: LtCheckDialog: LtCheckDialog called&quot;);</b>
&nbsp;        }
&nbsp;  
&nbsp;        
<b class="nc">&nbsp;        if (dialog == null) {</b>
<b class="nc">&nbsp;          MessageHandler.printToLogFile(&quot;CheckDialog: LtCheckDialog: LtCheckDialog == null&quot;);</b>
&nbsp;        }
<b class="nc">&nbsp;        dialog.setName(dialogName);</b>
<b class="nc">&nbsp;        dialog.setTitle(dialogName + &quot; (LanguageTool &quot; + OfficeTools.getLtInformation() + &quot;)&quot;);</b>
<b class="nc">&nbsp;        dialog.setDefaultCloseOperation(JDialog.DISPOSE_ON_CLOSE);</b>
<b class="nc">&nbsp;        ((Frame) dialog.getOwner()).setIconImage(ltImage);</b>
<b class="nc">&nbsp;        defaultForeground = dialog.getForeground() == null ? Color.BLACK : dialog.getForeground();</b>
&nbsp;  
<b class="nc">&nbsp;        Font dialogFont = languageLabel.getFont();</b>
<b class="nc">&nbsp;        languageLabel.setFont(dialogFont);</b>
&nbsp;  
<b class="nc">&nbsp;        language.setFont(dialogFont);</b>
<b class="nc">&nbsp;        language.setToolTipText(formatToolTipText(languageHelp));</b>
<b class="nc">&nbsp;        language.addItemListener(e -&gt; {</b>
<b class="nc">&nbsp;          if (e.getStateChange() == ItemEvent.SELECTED) {</b>
<b class="nc">&nbsp;            String selectedLang = (String) language.getSelectedItem();</b>
<b class="nc">&nbsp;            if (!lastLang.equals(selectedLang)) {</b>
<b class="nc">&nbsp;              changeLanguage.setEnabled(true);</b>
&nbsp;            }
&nbsp;          }
&nbsp;        });
&nbsp;  
<b class="nc">&nbsp;        changeLanguage.setFont(dialogFont);</b>
<b class="nc">&nbsp;        changeLanguage.setToolTipText(formatToolTipText(changeLanguageHelp));</b>
<b class="nc">&nbsp;        changeLanguage.addItemListener(e -&gt; {</b>
<b class="nc">&nbsp;          if (e.getStateChange() == ItemEvent.SELECTED) {</b>
<b class="nc">&nbsp;            if (changeLanguage.getSelectedIndex() &gt; 0) {</b>
<b class="nc">&nbsp;              Thread t = new Thread(new Runnable() {</b>
&nbsp;                public void run() {
&nbsp;                  try {
<b class="nc">&nbsp;                    Locale locale = null;</b>
<b class="nc">&nbsp;                    FlatParagraphTools flatPara= null;</b>
<b class="nc">&nbsp;                    setAtWorkButtonState();</b>
<b class="nc">&nbsp;                    String selectedLang = (String) language.getSelectedItem();</b>
<b class="nc">&nbsp;                    locale = getLocaleFromLanguageName(selectedLang);</b>
<b class="nc">&nbsp;                    flatPara = currentDocument.getFlatParagraphTools();</b>
<b class="nc">&nbsp;                    currentDocument.removeResultCache(y);</b>
<b class="nc">&nbsp;                    if (changeLanguage.getSelectedIndex() == 1) {</b>
<b class="nc">&nbsp;                      if (docType == DocumentType.IMPRESS) {</b>
<b class="nc">&nbsp;                        OfficeDrawTools.setLanguageOfParagraph(y, error.nErrorStart, error.nErrorLength, locale, currentDocument.getXComponent());</b>
<b class="nc">&nbsp;                      } else if (docType == DocumentType.CALC) {</b>
<b class="nc">&nbsp;                        OfficeSpreadsheetTools.setLanguageOfSpreadsheet(locale, currentDocument.getXComponent());</b>
&nbsp;                      } else {
<b class="nc">&nbsp;                        flatPara.setLanguageOfParagraph(y, error.nErrorStart, error.nErrorLength, locale);</b>
&nbsp;                      }
<b class="nc">&nbsp;                      addLanguageChangeUndo(y, error.nErrorStart, error.nErrorLength, lastLang);</b>
<b class="nc">&nbsp;                      docCache.setMultilingualFlatParagraph(y);</b>
<b class="nc">&nbsp;                    } else if (changeLanguage.getSelectedIndex() == 2) {</b>
<b class="nc">&nbsp;                      if (docType == DocumentType.IMPRESS) {</b>
<b class="nc">&nbsp;                        OfficeDrawTools.setLanguageOfParagraph(y, 0, docCache.getFlatParagraph(y).length(), locale, currentDocument.getXComponent());</b>
<b class="nc">&nbsp;                      } else if (docType == DocumentType.CALC) {</b>
<b class="nc">&nbsp;                        OfficeSpreadsheetTools.setLanguageOfSpreadsheet(locale, currentDocument.getXComponent());</b>
&nbsp;                      } else {
<b class="nc">&nbsp;                        flatPara.setLanguageOfParagraph(y, 0, docCache.getFlatParagraph(y).length(), locale);</b>
&nbsp;                      }
<b class="nc">&nbsp;                      docCache.setFlatParagraphLocale(y, locale);</b>
<b class="nc">&nbsp;                      addLanguageChangeUndo(y, 0, docCache.getFlatParagraph(y).length(), lastLang);</b>
&nbsp;                    }
<b class="nc">&nbsp;                    lastLang = selectedLang;</b>
<b class="nc">&nbsp;                    changeLanguage.setSelectedIndex(0);</b>
<b class="nc">&nbsp;                    gotoNextError();</b>
<b class="nc">&nbsp;                  } catch (Throwable t) {</b>
<b class="nc">&nbsp;                    MessageHandler.showError(t);</b>
<b class="nc">&nbsp;                    closeDialog();</b>
<b class="nc">&nbsp;                  }</b>
&nbsp;                }
&nbsp;              });
<b class="nc">&nbsp;              t.start();</b>
&nbsp;            }
&nbsp;          }
&nbsp;        });
<b class="nc">&nbsp;        changeLanguage.setSelectedIndex(0);</b>
<b class="nc">&nbsp;        changeLanguage.setEnabled(false);</b>
&nbsp;        
<b class="nc">&nbsp;        errorDescription.setEditable(false);</b>
<b class="nc">&nbsp;        errorDescription.setLineWrap(true);</b>
<b class="nc">&nbsp;        errorDescription.setWrapStyleWord(true);</b>
<b class="nc">&nbsp;        errorDescription.setBackground(dialog.getContentPane().getBackground());</b>
<b class="nc">&nbsp;        errorDescription.setText(checkStatusInitialization);</b>
<b class="nc">&nbsp;        errorDescription.setForeground(Color.RED);</b>
<b class="nc">&nbsp;        Font descriptionFont = dialogFont.deriveFont(Font.BOLD);</b>
<b class="nc">&nbsp;        errorDescription.setFont(descriptionFont);</b>
<b class="nc">&nbsp;        errorDescription.setToolTipText(formatToolTipText(matchDescriptionHelp));</b>
<b class="nc">&nbsp;        JScrollPane descriptionPane = new JScrollPane(errorDescription);</b>
<b class="nc">&nbsp;        descriptionPane.setMinimumSize(new Dimension(0, 20));</b>
&nbsp;  
<b class="nc">&nbsp;        sentenceIncludeError.setFont(dialogFont);</b>
<b class="nc">&nbsp;        sentenceIncludeError.setToolTipText(formatToolTipText(matchParagraphHelp));</b>
<b class="nc">&nbsp;        sentenceIncludeError.getDocument().addDocumentListener(new DocumentListener() {</b>
&nbsp;          @Override
&nbsp;          public void changedUpdate(DocumentEvent e) {
<b class="nc">&nbsp;            if (!blockSentenceError) {</b>
<b class="nc">&nbsp;              if (!change.isEnabled()) {</b>
<b class="nc">&nbsp;                change.setEnabled(true);</b>
&nbsp;              }
<b class="nc">&nbsp;              if (changeAll.isEnabled()) {</b>
<b class="nc">&nbsp;                changeAll.setEnabled(false);</b>
&nbsp;              }
<b class="nc">&nbsp;              if (autoCorrect.isEnabled()) {</b>
<b class="nc">&nbsp;                autoCorrect.setEnabled(false);</b>
&nbsp;              }
&nbsp;            }
&nbsp;          }
&nbsp;          @Override
&nbsp;          public void insertUpdate(DocumentEvent e) {
<b class="nc">&nbsp;            changedUpdate(e);</b>
&nbsp;          }
&nbsp;          @Override
&nbsp;          public void removeUpdate(DocumentEvent e) {
<b class="nc">&nbsp;            changedUpdate(e);</b>
&nbsp;          }
&nbsp;        });
<b class="nc">&nbsp;        JScrollPane sentencePane = new JScrollPane(sentenceIncludeError);</b>
<b class="nc">&nbsp;        sentencePane.setMinimumSize(new Dimension(0, 30));</b>
&nbsp;        
<b class="nc">&nbsp;        suggestionsLabel.setFont(dialogFont);</b>
&nbsp;  
<b class="nc">&nbsp;        suggestions.setFont(dialogFont);</b>
<b class="nc">&nbsp;        suggestions.setSelectionMode(ListSelectionModel.SINGLE_SELECTION);</b>
<b class="nc">&nbsp;        suggestions.setFixedCellHeight((int)(suggestions.getFont().getSize() * 1.2 + 0.5));</b>
<b class="nc">&nbsp;        suggestions.setToolTipText(formatToolTipText(suggestionsHelp));</b>
<b class="nc">&nbsp;        JScrollPane suggestionsPane = new JScrollPane(suggestions);</b>
<b class="nc">&nbsp;        suggestionsPane.setMinimumSize(new Dimension(0, 30));</b>
&nbsp;  
<b class="nc">&nbsp;        checkTypeLabel.setFont(dialogFont);</b>
<b class="nc">&nbsp;        checkTypeLabel.setToolTipText(formatToolTipText(checkTypeHelp));</b>
&nbsp;  
<b class="nc">&nbsp;        checkTypeButtons[0] = new JRadioButton(Tools.getLabel(messages.getString(&quot;guiOOoCheckAllButton&quot;)));</b>
<b class="nc">&nbsp;        checkTypeButtons[0].setSelected(true);</b>
<b class="nc">&nbsp;        checkTypeButtons[0].addActionListener(e -&gt; {</b>
<b class="nc">&nbsp;          setAtWorkButtonState();</b>
<b class="nc">&nbsp;          checkType = 0;</b>
<b class="nc">&nbsp;          Thread t = new Thread(new Runnable() {</b>
&nbsp;            public void run() {
&nbsp;              try {
<b class="nc">&nbsp;                setAtWorkButtonState();</b>
<b class="nc">&nbsp;                gotoNextError();</b>
<b class="nc">&nbsp;              } catch (Throwable t) {</b>
<b class="nc">&nbsp;                MessageHandler.showError(t);</b>
<b class="nc">&nbsp;                closeDialog();</b>
<b class="nc">&nbsp;              }</b>
&nbsp;            }
&nbsp;          });
<b class="nc">&nbsp;          t.start();</b>
&nbsp;        });
<b class="nc">&nbsp;        checkTypeButtons[1] = new JRadioButton(Tools.getLabel(messages.getString(&quot;guiOOoCheckSpellingButton&quot;)));</b>
<b class="nc">&nbsp;        checkTypeButtons[1].addActionListener(e -&gt; {</b>
<b class="nc">&nbsp;          setAtWorkButtonState();</b>
<b class="nc">&nbsp;          checkType = 1;</b>
<b class="nc">&nbsp;          Thread t = new Thread(new Runnable() {</b>
&nbsp;            public void run() {
&nbsp;              try {
<b class="nc">&nbsp;                setAtWorkButtonState();</b>
<b class="nc">&nbsp;                gotoNextError();</b>
<b class="nc">&nbsp;              } catch (Throwable t) {</b>
<b class="nc">&nbsp;                MessageHandler.showError(t);</b>
<b class="nc">&nbsp;                closeDialog();</b>
<b class="nc">&nbsp;              }</b>
&nbsp;            }
&nbsp;          });
<b class="nc">&nbsp;          t.start();</b>
&nbsp;        });
<b class="nc">&nbsp;        checkTypeButtons[2] = new JRadioButton(Tools.getLabel(messages.getString(&quot;guiOOoCheckGrammarButton&quot;)));</b>
<b class="nc">&nbsp;        checkTypeButtons[2].addActionListener(e -&gt; {</b>
<b class="nc">&nbsp;          setAtWorkButtonState();</b>
<b class="nc">&nbsp;          checkType = 2;</b>
<b class="nc">&nbsp;          Thread t = new Thread(new Runnable() {</b>
&nbsp;            public void run() {
&nbsp;              try {
<b class="nc">&nbsp;                setAtWorkButtonState();</b>
<b class="nc">&nbsp;                gotoNextError();</b>
<b class="nc">&nbsp;              } catch (Throwable t) {</b>
<b class="nc">&nbsp;                MessageHandler.showError(t);</b>
<b class="nc">&nbsp;                closeDialog();</b>
<b class="nc">&nbsp;              }</b>
&nbsp;            }
&nbsp;          });
<b class="nc">&nbsp;          t.start();</b>
&nbsp;        });
<b class="nc">&nbsp;        for (int i = 0; i &lt; 3; i++) {</b>
<b class="nc">&nbsp;          checkTypeGroup.add(checkTypeButtons[i]);</b>
<b class="nc">&nbsp;          checkTypeButtons[i].setFont(dialogFont);</b>
<b class="nc">&nbsp;          checkTypeButtons[i].setToolTipText(formatToolTipText(checkTypeHelp));</b>
&nbsp;        }
&nbsp;  
<b class="nc">&nbsp;        help.setFont(dialogFont);</b>
<b class="nc">&nbsp;        help.addActionListener(this);</b>
<b class="nc">&nbsp;        help.setActionCommand(&quot;help&quot;);</b>
<b class="nc">&nbsp;        help.setToolTipText(formatToolTipText(helpButtonHelp));</b>
&nbsp;        
<b class="nc">&nbsp;        options.setFont(dialogFont);</b>
<b class="nc">&nbsp;        options.addActionListener(this);</b>
<b class="nc">&nbsp;        options.setActionCommand(&quot;options&quot;);</b>
<b class="nc">&nbsp;        options.setToolTipText(formatToolTipText(optionsButtonHelp));</b>
&nbsp;        
<b class="nc">&nbsp;        undo.setFont(dialogFont);</b>
<b class="nc">&nbsp;        undo.addActionListener(this);</b>
<b class="nc">&nbsp;        undo.setActionCommand(&quot;undo&quot;);</b>
<b class="nc">&nbsp;        undo.setToolTipText(formatToolTipText(undoButtonHelp));</b>
&nbsp;        
<b class="nc">&nbsp;        close.setFont(dialogFont);</b>
<b class="nc">&nbsp;        close.addActionListener(this);</b>
<b class="nc">&nbsp;        close.setActionCommand(&quot;close&quot;);</b>
<b class="nc">&nbsp;        close.setToolTipText(formatToolTipText(closeButtonHelp));</b>
&nbsp;        
<b class="nc">&nbsp;        more.setFont(dialogFont);</b>
<b class="nc">&nbsp;        more.addActionListener(this);</b>
<b class="nc">&nbsp;        more.setActionCommand(&quot;more&quot;);</b>
<b class="nc">&nbsp;        more.setToolTipText(formatToolTipText(moreButtonHelp));</b>
&nbsp;        
<b class="nc">&nbsp;        ignoreOnce.setFont(dialogFont);</b>
<b class="nc">&nbsp;        ignoreOnce.addActionListener(this);</b>
<b class="nc">&nbsp;        ignoreOnce.setActionCommand(&quot;ignoreOnce&quot;);</b>
<b class="nc">&nbsp;        ignoreOnce.setToolTipText(formatToolTipText(ignoreButtonHelp));</b>
&nbsp;        
<b class="nc">&nbsp;        ignoreAll.setFont(dialogFont);</b>
<b class="nc">&nbsp;        ignoreAll.addActionListener(this);</b>
<b class="nc">&nbsp;        ignoreAll.setActionCommand(&quot;ignoreAll&quot;);</b>
<b class="nc">&nbsp;        ignoreAll.setToolTipText(formatToolTipText(ignoreAllButtonHelp));</b>
&nbsp;        
<b class="nc">&nbsp;        deactivateRule.setFont(dialogFont);</b>
<b class="nc">&nbsp;        deactivateRule.setVisible(false);</b>
<b class="nc">&nbsp;        deactivateRule.addActionListener(this);</b>
<b class="nc">&nbsp;        deactivateRule.setActionCommand(&quot;deactivateRule&quot;);</b>
<b class="nc">&nbsp;        deactivateRule.setToolTipText(formatToolTipText(deactivateRuleButtonHelp));</b>
&nbsp;        
<b class="nc">&nbsp;        addToDictionary.setFont(dialogFont);</b>
<b class="nc">&nbsp;        addToDictionary.setToolTipText(formatToolTipText(addToDictionaryHelp));</b>
<b class="nc">&nbsp;        addToDictionary.addItemListener(e -&gt; {</b>
<b class="nc">&nbsp;          if (e.getStateChange() == ItemEvent.SELECTED) {</b>
<b class="nc">&nbsp;            if (addToDictionary.getSelectedIndex() &gt; 0) {</b>
<b class="nc">&nbsp;              Thread t = new Thread(new Runnable() {</b>
&nbsp;                public void run() {
&nbsp;                  try {
<b class="nc">&nbsp;                    setAtWorkButtonState();</b>
<b class="nc">&nbsp;                    String dictionary = (String) addToDictionary.getSelectedItem();</b>
<b class="nc">&nbsp;                    documents.getLtDictionary().addWordToDictionary(dictionary, wrongWord, xContext);</b>
<b class="nc">&nbsp;                    addUndo(y, &quot;addToDictionary&quot;, dictionary, wrongWord);</b>
<b class="nc">&nbsp;                    addToDictionary.setSelectedIndex(0);</b>
<b class="nc">&nbsp;                    gotoNextError();</b>
<b class="nc">&nbsp;                  } catch (Throwable t) {</b>
<b class="nc">&nbsp;                    MessageHandler.showError(t);</b>
<b class="nc">&nbsp;                    closeDialog();</b>
<b class="nc">&nbsp;                  }</b>
&nbsp;                }
&nbsp;              });
<b class="nc">&nbsp;              t.start();</b>
&nbsp;            }
&nbsp;          }
&nbsp;        });
&nbsp;        
<b class="nc">&nbsp;        change.setFont(dialogFont);</b>
<b class="nc">&nbsp;        change.addActionListener(this);</b>
<b class="nc">&nbsp;        change.setActionCommand(&quot;change&quot;);</b>
<b class="nc">&nbsp;        change.setToolTipText(formatToolTipText(changeButtonHelp));</b>
&nbsp;        
<b class="nc">&nbsp;        changeAll.setFont(dialogFont);</b>
<b class="nc">&nbsp;        changeAll.addActionListener(this);</b>
<b class="nc">&nbsp;        changeAll.setActionCommand(&quot;changeAll&quot;);</b>
<b class="nc">&nbsp;        changeAll.setEnabled(false);</b>
<b class="nc">&nbsp;        changeAll.setToolTipText(formatToolTipText(changeAllButtonHelp));</b>
&nbsp;  
<b class="nc">&nbsp;        autoCorrect.setFont(dialogFont);</b>
<b class="nc">&nbsp;        autoCorrect.addActionListener(this);</b>
<b class="nc">&nbsp;        autoCorrect.setActionCommand(&quot;autoCorrect&quot;);</b>
<b class="nc">&nbsp;        autoCorrect.setEnabled(false);</b>
<b class="nc">&nbsp;        autoCorrect.setToolTipText(formatToolTipText(autoCorrectButtonHelp));</b>
&nbsp;  
<b class="nc">&nbsp;        activateRule.setFont(dialogFont);</b>
<b class="nc">&nbsp;        activateRule.setToolTipText(formatToolTipText(activateRuleButtonHelp));</b>
<b class="nc">&nbsp;        activateRule.setVisible(false);</b>
<b class="nc">&nbsp;        activateRule.addItemListener(e -&gt; {</b>
<b class="nc">&nbsp;          if (e.getStateChange() == ItemEvent.SELECTED) {</b>
<b class="nc">&nbsp;            Thread t = new Thread(new Runnable() {</b>
&nbsp;              public void run() {
&nbsp;                try {
<b class="nc">&nbsp;                  int selectedIndex = activateRule.getSelectedIndex();</b>
<b class="nc">&nbsp;                  if (selectedIndex &gt; 0) {</b>
<b class="nc">&nbsp;                    Map&lt;String, String&gt; deactivatedRulesMap = documents.getDisabledRulesMap(OfficeTools.localeToString(locale));</b>
<b class="nc">&nbsp;                    int j = 1;</b>
<b class="nc">&nbsp;                    for(String ruleId : deactivatedRulesMap.keySet()) {</b>
<b class="nc">&nbsp;                      if (j == selectedIndex) {</b>
<b class="nc">&nbsp;                        setAtWorkButtonState();</b>
<b class="nc">&nbsp;                        documents.activateRule(ruleId);</b>
<b class="nc">&nbsp;                        addUndo(y, &quot;activateRule&quot;, ruleId, null);</b>
<b class="nc">&nbsp;                        activateRule.setSelectedIndex(0);</b>
<b class="nc">&nbsp;                        gotoNextError();</b>
&nbsp;                      }
<b class="nc">&nbsp;                      j++;</b>
<b class="nc">&nbsp;                    }</b>
&nbsp;                  }
<b class="nc">&nbsp;                } catch (Throwable t) {</b>
<b class="nc">&nbsp;                  MessageHandler.showError(t);</b>
<b class="nc">&nbsp;                  closeDialog();</b>
<b class="nc">&nbsp;                }</b>
&nbsp;              }
&nbsp;            });
<b class="nc">&nbsp;            t.start();</b>
&nbsp;          }
&nbsp;        });
&nbsp;        
<b class="nc">&nbsp;        dialog.addWindowFocusListener(new WindowFocusListener() {</b>
&nbsp;          @Override
&nbsp;          public void windowGainedFocus(WindowEvent e) {
<b class="nc">&nbsp;            if (focusLost &amp;&amp; !atWork) {</b>
<b class="nc">&nbsp;              Thread t = new Thread(new Runnable() {</b>
&nbsp;                public void run() {
&nbsp;                  try {
<b class="nc">&nbsp;                    Point p = dialog.getLocation();</b>
<b class="nc">&nbsp;                    dialogX = p.x;</b>
<b class="nc">&nbsp;                    dialogY = p.y;</b>
<b class="nc">&nbsp;                    if (debugMode) {</b>
<b class="nc">&nbsp;                      MessageHandler.printToLogFile(&quot;CheckDialog: LtCheckDialog: Window Focus gained: Event = &quot; + e.paramString());</b>
&nbsp;                    }
<b class="nc">&nbsp;                    setAtWorkButtonState();</b>
<b class="nc">&nbsp;                    currentDocument = getCurrentDocument(true);</b>
<b class="nc">&nbsp;                    if (currentDocument == null) {</b>
<b class="nc">&nbsp;                      closeDialog();</b>
&nbsp;                      return;
&nbsp;                    }
<b class="nc">&nbsp;                    String newDocId = currentDocument.getDocID();</b>
<b class="nc">&nbsp;                    if (debugMode) {</b>
<b class="nc">&nbsp;                      MessageHandler.printToLogFile(&quot;CheckDialog: LtCheckDialog: Window Focus gained: new docID = &quot; + newDocId + &quot;, old = &quot; + docId + &quot;, docType: &quot; + docType);</b>
&nbsp;                    }
<b class="nc">&nbsp;                    if (!docId.equals(newDocId)) {</b>
<b class="nc">&nbsp;                      docId = newDocId;</b>
<b class="nc">&nbsp;                      undoList.clear();</b>
&nbsp;                    }
<b class="nc">&nbsp;                    if (!initCursor(false)) {</b>
<b class="nc">&nbsp;                      closeDialog();</b>
&nbsp;                      return;
&nbsp;                    }
<b class="nc">&nbsp;                    if (debugMode) {</b>
<b class="nc">&nbsp;                      MessageHandler.printToLogFile(&quot;CheckDialog: LtCheckDialog: cache refreshed - size: &quot; + docCache.size());</b>
&nbsp;                    }
<b class="nc">&nbsp;                    gotoNextError();</b>
<b class="nc">&nbsp;                    focusLost = false;</b>
<b class="nc">&nbsp;                  } catch (Throwable t) {</b>
<b class="nc">&nbsp;                    MessageHandler.showError(t);</b>
<b class="nc">&nbsp;                    closeDialog();</b>
<b class="nc">&nbsp;                  }</b>
&nbsp;                }
&nbsp;              });
<b class="nc">&nbsp;              t.start();</b>
&nbsp;            }
&nbsp;          }
&nbsp;          @Override
&nbsp;          public void windowLostFocus(WindowEvent e) {
<b class="nc">&nbsp;            Thread t = new Thread(new Runnable() {</b>
&nbsp;              public void run() {
&nbsp;                try {
<b class="nc">&nbsp;                  if (debugMode) {</b>
<b class="nc">&nbsp;                    MessageHandler.printToLogFile(&quot;CheckDialog: LtCheckDialog: Window Focus lost: Event = &quot; + e.paramString());</b>
&nbsp;                  }
<b class="nc">&nbsp;                  removeMarkups();</b>
<b class="nc">&nbsp;                  setAtWorkButtonState(atWork);</b>
<b class="nc">&nbsp;                  dialog.setEnabled(true);</b>
<b class="nc">&nbsp;                  focusLost = true;</b>
<b class="nc">&nbsp;                } catch (Throwable t) {</b>
<b class="nc">&nbsp;                  MessageHandler.showError(t);</b>
<b class="nc">&nbsp;                  closeDialog();</b>
<b class="nc">&nbsp;                }</b>
&nbsp;              }
&nbsp;            });
<b class="nc">&nbsp;            t.start();</b>
&nbsp;          }
&nbsp;        });
&nbsp;  
<b class="nc">&nbsp;        checkProgress.setStringPainted(true);</b>
<b class="nc">&nbsp;        checkProgress.setIndeterminate(true);</b>
&nbsp;  
&nbsp;        //  set selection background color to get compatible layout to LO
<b class="nc">&nbsp;        Color selectionColor = UIManager.getLookAndFeelDefaults().getColor(&quot;ProgressBar.selectionBackground&quot;);</b>
<b class="nc">&nbsp;        suggestions.setSelectionBackground(selectionColor);</b>
<b class="nc">&nbsp;        setJComboSelectionBackground(language, selectionColor);</b>
<b class="nc">&nbsp;        setJComboSelectionBackground(changeLanguage, selectionColor);</b>
<b class="nc">&nbsp;        setJComboSelectionBackground(addToDictionary, selectionColor);</b>
<b class="nc">&nbsp;        setJComboSelectionBackground(activateRule, selectionColor);</b>
&nbsp;  
&nbsp;        //  Define panels
&nbsp;  
&nbsp;        //  Define language panel
<b class="nc">&nbsp;        JPanel languagePanel = new JPanel();</b>
<b class="nc">&nbsp;        languagePanel.setLayout(new GridBagLayout());</b>
<b class="nc">&nbsp;        GridBagConstraints cons11 = new GridBagConstraints();</b>
<b class="nc">&nbsp;        cons11.insets = new Insets(2, 2, 2, 2);</b>
<b class="nc">&nbsp;        cons11.gridx = 0;</b>
<b class="nc">&nbsp;        cons11.gridy = 0;</b>
<b class="nc">&nbsp;        cons11.anchor = GridBagConstraints.NORTHWEST;</b>
<b class="nc">&nbsp;        cons11.fill = GridBagConstraints.HORIZONTAL;</b>
<b class="nc">&nbsp;        cons11.weightx = 0.0f;</b>
<b class="nc">&nbsp;        cons11.weighty = 0.0f;</b>
<b class="nc">&nbsp;        languagePanel.add(languageLabel, cons11);</b>
<b class="nc">&nbsp;        cons11.gridx++;</b>
<b class="nc">&nbsp;        cons11.weightx = 1.0f;</b>
<b class="nc">&nbsp;        languagePanel.add(language, cons11);</b>
&nbsp;  
&nbsp;        //  Define 1. right panel
<b class="nc">&nbsp;        JPanel rightPanel1 = new JPanel();</b>
<b class="nc">&nbsp;        rightPanel1.setLayout(new GridBagLayout());</b>
<b class="nc">&nbsp;        GridBagConstraints cons21 = new GridBagConstraints();</b>
<b class="nc">&nbsp;        cons21.insets = new Insets(2, 0, 2, 0);</b>
<b class="nc">&nbsp;        cons21.gridx = 0;</b>
<b class="nc">&nbsp;        cons21.gridy = 0;</b>
<b class="nc">&nbsp;        cons21.anchor = GridBagConstraints.NORTHWEST;</b>
<b class="nc">&nbsp;        cons21.fill = GridBagConstraints.BOTH;</b>
<b class="nc">&nbsp;        cons21.weightx = 1.0f;</b>
<b class="nc">&nbsp;        cons21.weighty = 0.0f;</b>
<b class="nc">&nbsp;        cons21.gridy++;</b>
<b class="nc">&nbsp;        rightPanel1.add(ignoreOnce, cons21);</b>
<b class="nc">&nbsp;        cons21.gridy++;</b>
<b class="nc">&nbsp;        rightPanel1.add(ignoreAll, cons21);</b>
<b class="nc">&nbsp;        cons21.gridy++;</b>
<b class="nc">&nbsp;        rightPanel1.add(deactivateRule, cons21);</b>
<b class="nc">&nbsp;        rightPanel1.add(addToDictionary, cons21);</b>
&nbsp;  
&nbsp;        //  Define 2. right panel
<b class="nc">&nbsp;        JPanel rightPanel2 = new JPanel();</b>
<b class="nc">&nbsp;        rightPanel2.setLayout(new GridBagLayout());</b>
<b class="nc">&nbsp;        GridBagConstraints cons22 = new GridBagConstraints();</b>
<b class="nc">&nbsp;        cons22.insets = new Insets(2, 0, 2, 0);</b>
<b class="nc">&nbsp;        cons22.gridx = 0;</b>
<b class="nc">&nbsp;        cons22.gridy = 0;</b>
<b class="nc">&nbsp;        cons22.anchor = GridBagConstraints.NORTHWEST;</b>
<b class="nc">&nbsp;        cons22.fill = GridBagConstraints.BOTH;</b>
<b class="nc">&nbsp;        cons22.weightx = 1.0f;</b>
<b class="nc">&nbsp;        cons22.weighty = 0.0f;</b>
<b class="nc">&nbsp;        cons22.gridy++;</b>
<b class="nc">&nbsp;        cons22.gridy++;</b>
<b class="nc">&nbsp;        rightPanel2.add(change, cons22);</b>
<b class="nc">&nbsp;        cons22.gridy++;</b>
<b class="nc">&nbsp;        rightPanel2.add(changeAll, cons22);</b>
<b class="nc">&nbsp;        cons22.gridy++;</b>
<b class="nc">&nbsp;        rightPanel2.add(autoCorrect, cons22);</b>
<b class="nc">&nbsp;        rightPanel2.add(activateRule, cons22);</b>
&nbsp;        
&nbsp;        //  Define language panel
<b class="nc">&nbsp;        JPanel checkTypePanel = new JPanel();</b>
<b class="nc">&nbsp;        checkTypePanel.setLayout(new GridBagLayout());</b>
<b class="nc">&nbsp;        GridBagConstraints cons12 = new GridBagConstraints();</b>
<b class="nc">&nbsp;        cons12.insets = new Insets(2, 2, 2, 2);</b>
<b class="nc">&nbsp;        cons12.gridx = 0;</b>
<b class="nc">&nbsp;        cons12.gridy = 0;</b>
<b class="nc">&nbsp;        cons12.anchor = GridBagConstraints.NORTHWEST;</b>
<b class="nc">&nbsp;        cons12.fill = GridBagConstraints.HORIZONTAL;</b>
<b class="nc">&nbsp;        cons12.weightx = 1.0f;</b>
<b class="nc">&nbsp;        cons12.weighty = 0.0f;</b>
<b class="nc">&nbsp;        checkTypePanel.add(checkTypeLabel, cons12);</b>
<b class="nc">&nbsp;        for (int i = 0; i &lt; 3; i++) {</b>
<b class="nc">&nbsp;          cons12.gridx++;</b>
<b class="nc">&nbsp;          checkTypePanel.add(checkTypeButtons[i], cons12);</b>
&nbsp;        }
&nbsp;        
&nbsp;        //  Define main panel
<b class="nc">&nbsp;        JPanel mainPanel = new JPanel();</b>
<b class="nc">&nbsp;        mainPanel.setLayout(new GridBagLayout());</b>
<b class="nc">&nbsp;        GridBagConstraints cons1 = new GridBagConstraints();</b>
<b class="nc">&nbsp;        cons1.insets = new Insets(4, 4, 4, 4);</b>
<b class="nc">&nbsp;        cons1.gridx = 0;</b>
<b class="nc">&nbsp;        cons1.gridy = 0;</b>
<b class="nc">&nbsp;        cons1.anchor = GridBagConstraints.NORTHWEST;</b>
<b class="nc">&nbsp;        cons1.fill = GridBagConstraints.BOTH;</b>
<b class="nc">&nbsp;        cons1.weightx = 1.0f;</b>
<b class="nc">&nbsp;        cons1.weighty = 0.0f;</b>
<b class="nc">&nbsp;        mainPanel.add(languagePanel, cons1);</b>
<b class="nc">&nbsp;        cons1.weightx = 0.0f;</b>
<b class="nc">&nbsp;        cons1.gridx++;</b>
<b class="nc">&nbsp;        mainPanel.add(changeLanguage, cons1);</b>
<b class="nc">&nbsp;        cons1.gridx = 0;</b>
<b class="nc">&nbsp;        cons1.gridy++;</b>
<b class="nc">&nbsp;        cons1.weightx = 1.0f;</b>
<b class="nc">&nbsp;        cons1.weighty = 1.0f;</b>
<b class="nc">&nbsp;        mainPanel.add(descriptionPane, cons1);</b>
<b class="nc">&nbsp;        cons1.gridx++;</b>
<b class="nc">&nbsp;        cons1.weightx = 0.0f;</b>
<b class="nc">&nbsp;        cons1.weighty = 0.0f;</b>
<b class="nc">&nbsp;        mainPanel.add(more, cons1);</b>
<b class="nc">&nbsp;        cons1.gridx = 0;</b>
<b class="nc">&nbsp;        cons1.gridy++;</b>
<b class="nc">&nbsp;        cons1.weightx = 1.0f;</b>
<b class="nc">&nbsp;        cons1.weighty = 2.0f;</b>
<b class="nc">&nbsp;        mainPanel.add(sentencePane, cons1);</b>
<b class="nc">&nbsp;        cons1.gridx++;</b>
<b class="nc">&nbsp;        cons1.weightx = 0.0f;</b>
<b class="nc">&nbsp;        cons1.weighty = 0.0f;</b>
<b class="nc">&nbsp;        mainPanel.add(rightPanel1, cons1);</b>
<b class="nc">&nbsp;        cons1.gridx = 0;</b>
<b class="nc">&nbsp;        cons1.gridy++;</b>
<b class="nc">&nbsp;        cons1.weightx = 1.0f;</b>
<b class="nc">&nbsp;        mainPanel.add(suggestionsLabel, cons1);</b>
<b class="nc">&nbsp;        cons1.gridy++;</b>
<b class="nc">&nbsp;        cons1.weighty = 2.0f;</b>
<b class="nc">&nbsp;        mainPanel.add(suggestionsPane, cons1);</b>
<b class="nc">&nbsp;        cons1.gridx++;</b>
<b class="nc">&nbsp;        cons1.weightx = 0.0f;</b>
<b class="nc">&nbsp;        cons1.weighty = 0.0f;</b>
<b class="nc">&nbsp;        mainPanel.add(rightPanel2, cons1);</b>
<b class="nc">&nbsp;        cons1.gridx = 0;</b>
<b class="nc">&nbsp;        cons1.gridy++;</b>
<b class="nc">&nbsp;        cons1.weightx = 1.0f;</b>
<b class="nc">&nbsp;        cons1.weighty = 0.0f;</b>
<b class="nc">&nbsp;        mainPanel.add(checkTypePanel, cons1);</b>
&nbsp;  
&nbsp;        //  Define general button panel
<b class="nc">&nbsp;        JPanel generalButtonPanel = new JPanel();</b>
<b class="nc">&nbsp;        generalButtonPanel.setLayout(new GridBagLayout());</b>
<b class="nc">&nbsp;        GridBagConstraints cons3 = new GridBagConstraints();</b>
<b class="nc">&nbsp;        cons3.insets = new Insets(4, 4, 4, 4);</b>
<b class="nc">&nbsp;        cons3.gridx = 0;</b>
<b class="nc">&nbsp;        cons3.gridy = 0;</b>
<b class="nc">&nbsp;        cons3.anchor = GridBagConstraints.NORTHWEST;</b>
<b class="nc">&nbsp;        cons3.fill = GridBagConstraints.HORIZONTAL;</b>
<b class="nc">&nbsp;        cons3.weightx = 1.0f;</b>
<b class="nc">&nbsp;        cons3.weighty = 0.0f;</b>
<b class="nc">&nbsp;        generalButtonPanel.add(help, cons3);</b>
<b class="nc">&nbsp;        cons3.gridx++;</b>
<b class="nc">&nbsp;        generalButtonPanel.add(options, cons3);</b>
<b class="nc">&nbsp;        cons3.gridx++;</b>
<b class="nc">&nbsp;        generalButtonPanel.add(undo, cons3);</b>
<b class="nc">&nbsp;        cons3.gridx++;</b>
<b class="nc">&nbsp;        generalButtonPanel.add(close, cons3);</b>
&nbsp;        
&nbsp;        //  Define check progress panel
<b class="nc">&nbsp;        JPanel checkProgressPanel = new JPanel();</b>
<b class="nc">&nbsp;        checkProgressPanel.setLayout(new GridBagLayout());</b>
<b class="nc">&nbsp;        GridBagConstraints cons4 = new GridBagConstraints();</b>
<b class="nc">&nbsp;        cons4.insets = new Insets(4, 4, 4, 4);</b>
<b class="nc">&nbsp;        cons4.gridx = 0;</b>
<b class="nc">&nbsp;        cons4.gridy = 0;</b>
<b class="nc">&nbsp;        cons4.anchor = GridBagConstraints.NORTHWEST;</b>
<b class="nc">&nbsp;        cons4.fill = GridBagConstraints.HORIZONTAL;</b>
<b class="nc">&nbsp;        cons4.weightx = 0.0f;</b>
<b class="nc">&nbsp;        cons4.weighty = 0.0f;</b>
<b class="nc">&nbsp;        checkProgressPanel.add(checkProgressLabel, cons4);</b>
<b class="nc">&nbsp;        cons4.gridx++;</b>
<b class="nc">&nbsp;        cons4.weightx = 4.0f;</b>
<b class="nc">&nbsp;        checkProgressPanel.add(checkProgress, cons4);</b>
&nbsp;  
<b class="nc">&nbsp;        contentPane.setLayout(new GridBagLayout());</b>
<b class="nc">&nbsp;        GridBagConstraints cons = new GridBagConstraints();</b>
<b class="nc">&nbsp;        cons.insets = new Insets(8, 8, 8, 8);</b>
<b class="nc">&nbsp;        cons.gridx = 0;</b>
<b class="nc">&nbsp;        cons.gridy = 0;</b>
<b class="nc">&nbsp;        cons.anchor = GridBagConstraints.NORTHWEST;</b>
<b class="nc">&nbsp;        cons.fill = GridBagConstraints.BOTH;</b>
<b class="nc">&nbsp;        cons.weightx = 1.0f;</b>
<b class="nc">&nbsp;        cons.weighty = 1.0f;</b>
<b class="nc">&nbsp;        contentPane.add(mainPanel, cons);</b>
<b class="nc">&nbsp;        cons.gridy++;</b>
<b class="nc">&nbsp;        cons.weighty = 0.0f;</b>
<b class="nc">&nbsp;        contentPane.add(generalButtonPanel, cons);</b>
<b class="nc">&nbsp;        cons.gridy++;</b>
<b class="nc">&nbsp;        contentPane.add(checkProgressPanel, cons);</b>
&nbsp;  
<b class="nc">&nbsp;        dialog.pack();</b>
&nbsp;        // center on screen:
<b class="nc">&nbsp;        Dimension screenSize = Toolkit.getDefaultToolkit().getScreenSize();</b>
&nbsp;  //    Dimension frameSize = dialog.getSize();
<b class="nc">&nbsp;        Dimension frameSize = new Dimension(dialogWidth, dialogHeight);</b>
<b class="nc">&nbsp;        dialog.setSize(frameSize);</b>
<b class="nc">&nbsp;        dialog.setLocation(screenSize.width / 2 - frameSize.width / 2,</b>
&nbsp;            screenSize.height / 2 - frameSize.height / 2);
<b class="nc">&nbsp;        dialog.setLocationByPlatform(true);</b>
&nbsp;        
<b class="nc">&nbsp;        ToolTipManager.sharedInstance().setDismissDelay(30000);</b>
<b class="nc">&nbsp;      } catch (Throwable t) {</b>
<b class="nc">&nbsp;        MessageHandler.showError(t);</b>
<b class="nc">&nbsp;        closeDialog();</b>
<b class="nc">&nbsp;      }</b>
&nbsp;    }
&nbsp;    
&nbsp;    /**
&nbsp;     * Set the selection color to a combo box
&nbsp;     */
&nbsp;    private void setJComboSelectionBackground(JComboBox&lt;String&gt; comboBox, Color color) {
<b class="nc">&nbsp;      Object context = comboBox.getAccessibleContext().getAccessibleChild(0);</b>
<b class="nc">&nbsp;      BasicComboPopup popup = (BasicComboPopup)context;</b>
<b class="nc">&nbsp;      JList&lt;Object&gt; list = popup.getList();</b>
<b class="nc">&nbsp;      list.setSelectionBackground(color);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Set the Progress value for the progress bar
&nbsp;     * The checked number of paragraphs and the percent of checked of paragraphs are printed
&nbsp;     */
&nbsp;    void setProgressValue(int value, boolean setText) {
<b class="nc">&nbsp;      int max = checkProgress.getMaximum();</b>
<b class="nc">&nbsp;      int val = value &lt; 0 ? 1 : value + 1;</b>
<b class="nc">&nbsp;      if (val &gt; max) {</b>
<b class="nc">&nbsp;        val = max;</b>
&nbsp;      }
<b class="nc">&nbsp;      checkProgress.setValue(val);</b>
<b class="nc">&nbsp;      if (setText) {</b>
<b class="nc">&nbsp;        int p = (int) (((val * 100) / max) + 0.5);</b>
<b class="nc">&nbsp;        checkProgress.setString(p + &quot; %  ( &quot; + val + &quot; / &quot; + max + &quot; )&quot;);</b>
<b class="nc">&nbsp;        checkProgress.setStringPainted(true);</b>
&nbsp;      }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * show the dialog
&nbsp;     * @throws Throwable 
&nbsp;     */
&nbsp;    public void show() throws Throwable {
<b class="nc">&nbsp;      if (debugMode) {</b>
<b class="nc">&nbsp;        MessageHandler.printToLogFile(&quot;CheckDialog: show: Goto next Error&quot;);</b>
&nbsp;      }
<b class="nc">&nbsp;      if (dialogX &lt; 0 || dialogY &lt; 0) {</b>
<b class="nc">&nbsp;        Dimension screenSize = Toolkit.getDefaultToolkit().getScreenSize();</b>
<b class="nc">&nbsp;        Dimension frameSize = dialog.getSize();</b>
<b class="nc">&nbsp;        dialogX = screenSize.width / 2 - frameSize.width / 2;</b>
<b class="nc">&nbsp;        dialogY = screenSize.height / 2 - frameSize.height / 2;</b>
&nbsp;      }
<b class="nc">&nbsp;      dialog.setLocation(dialogX, dialogY);</b>
<b class="nc">&nbsp;      dialog.setAutoRequestFocus(true);</b>
<b class="nc">&nbsp;      dialog.setVisible(true);</b>
<b class="nc">&nbsp;      Thread t = new Thread(new Runnable() {</b>
&nbsp;        public void run() {
&nbsp;          try {
<b class="nc">&nbsp;            setAtWorkButtonState();</b>
<b class="nc">&nbsp;            dialog.toFront();</b>
<b class="nc">&nbsp;            currentDocument = getCurrentDocument(false);</b>
<b class="nc">&nbsp;            docId = currentDocument.getDocID();</b>
<b class="nc">&nbsp;            if (docCache == null || docCache.size() &lt;= 0) {</b>
&nbsp;              return;
&nbsp;            }
<b class="nc">&nbsp;            if (spellChecker == null) {</b>
<b class="nc">&nbsp;              spellChecker = new ExtensionSpellChecker();</b>
&nbsp;            }
<b class="nc">&nbsp;            if (lt == null || !documents.isCheckImpressDocument()) {</b>
<b class="nc">&nbsp;              setLangTool(documents, lastLanguage);</b>
&nbsp;            }
<b class="nc">&nbsp;            setUserDictionaries();</b>
<b class="nc">&nbsp;            for (String dic : userDictionaries) {</b>
<b class="nc">&nbsp;              addToDictionary.addItem(dic);</b>
&nbsp;            }
<b class="nc">&nbsp;            if (!initCursor(true)) {</b>
&nbsp;              return;
&nbsp;            }
<b class="nc">&nbsp;            gotoNextError(false);</b>
<b class="nc">&nbsp;          } catch (Throwable t) {</b>
<b class="nc">&nbsp;            MessageHandler.showError(t);</b>
<b class="nc">&nbsp;            closeDialog();</b>
<b class="nc">&nbsp;          }</b>
&nbsp;        }
&nbsp;      });
<b class="nc">&nbsp;      t.start();</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Initialize the cursor / define the range for check
&nbsp;     * @throws Throwable 
&nbsp;     */
&nbsp;    private boolean initCursor(boolean isStart) throws Throwable {
<b class="nc">&nbsp;      if (docType == DocumentType.WRITER) {</b>
<b class="nc">&nbsp;        viewCursor = new ViewCursorTools(currentDocument.getXComponent());</b>
<b class="nc">&nbsp;        if (debugMode) {</b>
<b class="nc">&nbsp;          MessageHandler.printToLogFile(&quot;CheckDialog: initCursor: viewCursor initialized: docId: &quot; + docId);</b>
&nbsp;        }
<b class="nc">&nbsp;        XTextCursor tCursor = viewCursor.getTextCursorBeginn();</b>
<b class="nc">&nbsp;        if (tCursor != null) {</b>
<b class="nc">&nbsp;          tCursor.gotoStart(true);</b>
<b class="nc">&nbsp;          int nBegin = tCursor.getString().length();</b>
<b class="nc">&nbsp;          tCursor = viewCursor.getTextCursorEnd();</b>
<b class="nc">&nbsp;          tCursor.gotoStart(true);</b>
<b class="nc">&nbsp;          int nEnd = tCursor.getString().length();</b>
<b class="nc">&nbsp;          if (nBegin &lt; nEnd) {</b>
<b class="nc">&nbsp;            startOfRange = viewCursor.getViewCursorCharacter();</b>
<b class="nc">&nbsp;            endOfRange = nEnd - nBegin + startOfRange;</b>
<b class="nc">&nbsp;            lastX = 0;</b>
<b class="nc">&nbsp;            lastY = -1;</b>
&nbsp;          } else {
<b class="nc">&nbsp;            startOfRange = -1;</b>
<b class="nc">&nbsp;            endOfRange = -1;</b>
&nbsp;          }
<b class="nc">&nbsp;        } else {</b>
<b class="nc">&nbsp;          closeDialog();</b>
<b class="nc">&nbsp;          MessageHandler.showClosingInformationDialog(messages.getString(&quot;loDialogUnsupported&quot;));</b>
<b class="nc">&nbsp;          return false;</b>
&nbsp;        }
<b class="nc">&nbsp;      } else {</b>
<b class="nc">&nbsp;        startOfRange = -1;</b>
<b class="nc">&nbsp;        endOfRange = -1;</b>
&nbsp;      }
<b class="nc">&nbsp;      if (isStart || endOfRange &gt; 0) {</b>
<b class="nc">&nbsp;        lastPara = -1;</b>
&nbsp;      }
<b class="nc">&nbsp;      return true;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Formats the tooltip text
&nbsp;     * The text is given by a text string which is formated into html:
&nbsp;     * \n are formated to html paragraph breaks
&nbsp;     * \n- is formated to an unordered List
&nbsp;     * \n1. is formated to an ordered List (every digit 1 - 9 is allowed 
&nbsp;     */
&nbsp;    private String formatToolTipText(String Text) {
<b class="nc">&nbsp;      String toolTipText = Text;</b>
<b class="nc">&nbsp;      int breakIndex = 0;</b>
<b class="nc">&nbsp;      int isNum = 0;</b>
<b class="nc">&nbsp;      while (breakIndex &gt;= 0) {</b>
<b class="nc">&nbsp;        breakIndex = toolTipText.indexOf(&quot;\n&quot;, breakIndex);</b>
<b class="nc">&nbsp;        if (breakIndex &gt;= 0) {</b>
<b class="nc">&nbsp;          int nextNonBlank = breakIndex + 1;</b>
<b class="nc">&nbsp;          while (&#39; &#39; == toolTipText.charAt(nextNonBlank)) {</b>
<b class="nc">&nbsp;            nextNonBlank++;</b>
&nbsp;          }
<b class="nc">&nbsp;          if (isNum == 0) {</b>
<b class="nc">&nbsp;            if (toolTipText.charAt(nextNonBlank) == &#39;-&#39;) {</b>
<b class="nc">&nbsp;              toolTipText = toolTipText.substring(0, breakIndex) + &quot;&lt;/p&gt;&lt;ul width=\&quot;&quot; </b>
<b class="nc">&nbsp;                  + toolTipWidth + &quot;\&quot;&gt;&lt;li&gt;&quot; + toolTipText.substring(nextNonBlank + 1);</b>
<b class="nc">&nbsp;              isNum = 1;</b>
<b class="nc">&nbsp;            } else if (toolTipText.charAt(nextNonBlank) &gt;= &#39;1&#39; &amp;&amp; toolTipText.charAt(nextNonBlank) &lt;= &#39;9&#39; </b>
<b class="nc">&nbsp;                            &amp;&amp; toolTipText.charAt(nextNonBlank + 1) == &#39;.&#39;) {</b>
<b class="nc">&nbsp;              toolTipText = toolTipText.substring(0, breakIndex) + &quot;&lt;/p&gt;&lt;ol width=\&quot;&quot; </b>
<b class="nc">&nbsp;                  + toolTipWidth + &quot;\&quot;&gt;&lt;li&gt;&quot; + toolTipText.substring(nextNonBlank + 2);</b>
<b class="nc">&nbsp;              isNum = 2;</b>
&nbsp;            } else {
<b class="nc">&nbsp;              toolTipText = toolTipText.substring(0, breakIndex) + &quot;&lt;/p&gt;&lt;p width=\&quot;&quot; </b>
<b class="nc">&nbsp;                              + toolTipWidth + &quot;\&quot;&gt;&quot; + toolTipText.substring(breakIndex + 1);</b>
&nbsp;            }
<b class="nc">&nbsp;          } else if (isNum == 1) {</b>
<b class="nc">&nbsp;            if (toolTipText.charAt(nextNonBlank) == &#39;-&#39;) {</b>
<b class="nc">&nbsp;              toolTipText = toolTipText.substring(0, breakIndex) + &quot;&lt;/li&gt;&lt;li&gt;&quot; + toolTipText.substring(nextNonBlank + 1);</b>
&nbsp;            } else {
<b class="nc">&nbsp;              toolTipText = toolTipText.substring(0, breakIndex) + &quot;&lt;/li&gt;&lt;/ul&gt;&lt;p width=\&quot;&quot; </b>
<b class="nc">&nbsp;                  + toolTipWidth + &quot;\&quot;&gt;&quot; + toolTipText.substring(breakIndex + 1);</b>
<b class="nc">&nbsp;              isNum = 0;</b>
&nbsp;            }
&nbsp;          } else {
<b class="nc">&nbsp;            if (toolTipText.charAt(nextNonBlank) &gt;= &#39;1&#39; &amp;&amp; toolTipText.charAt(nextNonBlank) &lt;= &#39;9&#39; </b>
<b class="nc">&nbsp;                &amp;&amp; toolTipText.charAt(nextNonBlank + 1) == &#39;.&#39;) {</b>
<b class="nc">&nbsp;              toolTipText = toolTipText.substring(0, breakIndex) + &quot;&lt;/li&gt;&lt;li&gt;&quot; + toolTipText.substring(nextNonBlank + 2);</b>
&nbsp;            } else {
<b class="nc">&nbsp;              toolTipText = toolTipText.substring(0, breakIndex) + &quot;&lt;/li&gt;&lt;/ol&gt;&lt;p width=\&quot;&quot; </b>
<b class="nc">&nbsp;                  + toolTipWidth + &quot;\&quot;&gt;&quot; + toolTipText.substring(breakIndex + 1);</b>
<b class="nc">&nbsp;              isNum = 0;</b>
&nbsp;            }
&nbsp;          }
<b class="nc">&nbsp;        }</b>
&nbsp;      }
<b class="nc">&nbsp;      if (isNum == 0) {</b>
<b class="nc">&nbsp;        toolTipText = &quot;&lt;html&gt;&lt;div style=&#39;color:black;&#39;&gt;&lt;p width=\&quot;&quot; + toolTipWidth + &quot;\&quot;&gt;&quot; + toolTipText + &quot;&lt;/p&gt;&lt;/html&gt;&quot;;</b>
<b class="nc">&nbsp;      } else if (isNum == 1) {</b>
<b class="nc">&nbsp;        toolTipText = &quot;&lt;html&gt;&lt;div style=&#39;color:black;&#39;&gt;&lt;p width=\&quot;&quot; + toolTipWidth + &quot;\&quot;&gt;&quot; + toolTipText + &quot;&lt;/ul&gt;&lt;/html&gt;&quot;;</b>
&nbsp;      } else {
<b class="nc">&nbsp;        toolTipText = &quot;&lt;html&gt;&lt;div style=&#39;color:black;&#39;&gt;&lt;p width=\&quot;&quot; + toolTipWidth + &quot;\&quot;&gt;&quot; + toolTipText + &quot;&lt;/ol&gt;&lt;/html&gt;&quot;;</b>
&nbsp;      }
<b class="nc">&nbsp;      return toolTipText;</b>
&nbsp;    }
&nbsp;    
&nbsp;    /**
&nbsp;     * Initial button state
&nbsp;     */
&nbsp;    private void setAtWorkButtonState() {
<b class="nc">&nbsp;      setAtWorkButtonState(true);</b>
&nbsp;    }
&nbsp;    
&nbsp;    private void setAtWorkButtonState(boolean work) {
<b class="nc">&nbsp;      checkProgress.setIndeterminate(true);</b>
<b class="nc">&nbsp;      ignoreOnce.setEnabled(false);</b>
<b class="nc">&nbsp;      ignoreAll.setEnabled(false);</b>
<b class="nc">&nbsp;      deactivateRule.setEnabled(false);</b>
<b class="nc">&nbsp;      change.setEnabled(false);</b>
<b class="nc">&nbsp;      changeAll.setEnabled(false);</b>
<b class="nc">&nbsp;      autoCorrect.setEnabled(false);</b>
<b class="nc">&nbsp;      addToDictionary.setEnabled(false);</b>
<b class="nc">&nbsp;      more.setEnabled(false);</b>
<b class="nc">&nbsp;      help.setEnabled(false);</b>
<b class="nc">&nbsp;      options.setEnabled(false);</b>
<b class="nc">&nbsp;      undo.setEnabled(false);</b>
<b class="nc">&nbsp;      close.setEnabled(false);</b>
<b class="nc">&nbsp;      language.setEnabled(false);</b>
<b class="nc">&nbsp;      changeLanguage.setEnabled(false);</b>
<b class="nc">&nbsp;      activateRule.setEnabled(false);</b>
<b class="nc">&nbsp;      endOfDokumentMessage = null;</b>
<b class="nc">&nbsp;      sentenceIncludeError.setBackground(Color.LIGHT_GRAY);</b>
<b class="nc">&nbsp;      sentenceIncludeError.setEnabled(false);</b>
<b class="nc">&nbsp;      suggestions.setBackground(Color.LIGHT_GRAY);</b>
<b class="nc">&nbsp;      suggestions.setEnabled(false);</b>
<b class="nc">&nbsp;      errorDescription.setText(checkStatusCheck);</b>
<b class="nc">&nbsp;      errorDescription.setForeground(Color.RED);</b>
<b class="nc">&nbsp;      errorDescription.setBackground(Color.LIGHT_GRAY);</b>
<b class="nc">&nbsp;      contentPane.revalidate();</b>
<b class="nc">&nbsp;      contentPane.repaint();</b>
<b class="nc">&nbsp;      dialog.setEnabled(false);</b>
<b class="nc">&nbsp;      atWork = work;</b>
&nbsp;    }
&nbsp;    
&nbsp;    /**
&nbsp;     * find the next match
&nbsp;     * set the view cursor to the position of match
&nbsp;     * fill the elements of the dialog with the information of the match
&nbsp;     */
&nbsp;    private void gotoNextError() {
<b class="nc">&nbsp;      gotoNextError(true);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void gotoNextError(boolean startAtBegin) {
&nbsp;      try {
<b class="nc">&nbsp;        if (!documents.isEnoughHeapSpace()) {</b>
<b class="nc">&nbsp;          closeDialog();</b>
&nbsp;          return;
&nbsp;        }
<b class="nc">&nbsp;        if (debugMode) {</b>
<b class="nc">&nbsp;          MessageHandler.printToLogFile(&quot;CheckDialog: findNextError: start getNextError&quot;);</b>
&nbsp;        }
<b class="nc">&nbsp;        removeMarkups();</b>
<b class="nc">&nbsp;        CheckError checkError = getNextError(startAtBegin);</b>
<b class="nc">&nbsp;        if (debugMode) {</b>
<b class="nc">&nbsp;          MessageHandler.printToLogFile(&quot;CheckDialog: findNextError: Error is &quot; + (checkError == null ? &quot;Null&quot; : &quot;NOT Null&quot;));</b>
&nbsp;        }
<b class="nc">&nbsp;        error = checkError == null ? null : checkError.error;</b>
<b class="nc">&nbsp;        locale = checkError == null ? null : checkError.locale;</b>
&nbsp;        
<b class="nc">&nbsp;        dialog.setEnabled(true);</b>
<b class="nc">&nbsp;        checkProgress.setIndeterminate(false);</b>
<b class="nc">&nbsp;        help.setEnabled(true);</b>
<b class="nc">&nbsp;        options.setEnabled(true);</b>
<b class="nc">&nbsp;        close.setEnabled(true);</b>
<b class="nc">&nbsp;        if (sentenceIncludeError == null || errorDescription == null || suggestions == null) {</b>
<b class="nc">&nbsp;          MessageHandler.printToLogFile(&quot;CheckDialog: findNextError: SentenceIncludeError == null || errorDescription == null || suggestions == null&quot;);</b>
<b class="nc">&nbsp;          error = null;</b>
&nbsp;        }
&nbsp;        
<b class="nc">&nbsp;        if (error != null) {</b>
<b class="nc">&nbsp;          isSpellError = error.aRuleIdentifier.equals(spellRuleId);</b>
<b class="nc">&nbsp;          blockSentenceError = true;</b>
<b class="nc">&nbsp;          sentenceIncludeError.setEnabled(true);</b>
<b class="nc">&nbsp;          sentenceIncludeError.setBackground(Color.white);</b>
<b class="nc">&nbsp;          sentenceIncludeError.setText(docCache.getFlatParagraph(y));</b>
<b class="nc">&nbsp;          setAttributesForErrorText(error);</b>
<b class="nc">&nbsp;          blockSentenceError = false;</b>
<b class="nc">&nbsp;          errorDescription.setEnabled(true);</b>
<b class="nc">&nbsp;          errorDescription.setText(error.aFullComment);</b>
<b class="nc">&nbsp;          errorDescription.setForeground(defaultForeground);</b>
<b class="nc">&nbsp;          errorDescription.setBackground(Color.white);</b>
<b class="nc">&nbsp;          ignoreOnce.setEnabled(true);</b>
<b class="nc">&nbsp;          ignoreAll.setEnabled(true);</b>
<b class="nc">&nbsp;          if (debugMode) {</b>
<b class="nc">&nbsp;            MessageHandler.printToLogFile(&quot;CheckDialog: findNextError: Error Text set&quot;);</b>
&nbsp;          }
<b class="nc">&nbsp;          if (error.aSuggestions != null &amp;&amp; error.aSuggestions.length &gt; 0) {</b>
<b class="nc">&nbsp;            suggestions.setEnabled(true);</b>
<b class="nc">&nbsp;            suggestions.setListData(error.aSuggestions);</b>
<b class="nc">&nbsp;            suggestions.setSelectedIndex(0);</b>
<b class="nc">&nbsp;            suggestions.setBackground(Color.white);</b>
<b class="nc">&nbsp;            change.setEnabled(true);</b>
<b class="nc">&nbsp;            changeAll.setEnabled(true);</b>
<b class="nc">&nbsp;            autoCorrect.setEnabled(true);</b>
&nbsp;          } else {
<b class="nc">&nbsp;            suggestions.setEnabled(true);</b>
<b class="nc">&nbsp;            suggestions.setListData(new String[0]);</b>
<b class="nc">&nbsp;            change.setEnabled(false);</b>
<b class="nc">&nbsp;            changeAll.setEnabled(false);</b>
<b class="nc">&nbsp;            autoCorrect.setEnabled(false);</b>
&nbsp;          }
<b class="nc">&nbsp;          if (debugMode) {</b>
<b class="nc">&nbsp;            MessageHandler.printToLogFile(&quot;CheckDialog: findNextError: Suggestions set&quot;);</b>
&nbsp;          }
<b class="nc">&nbsp;          Language lang = locale == null ? lt.getLanguage() : documents.getLanguage(locale);</b>
<b class="nc">&nbsp;          if (debugMode &amp;&amp; lt.getLanguage() == null) {</b>
<b class="nc">&nbsp;            MessageHandler.printToLogFile(&quot;CheckDialog: findNextError: LT language == null&quot;);</b>
&nbsp;          }
<b class="nc">&nbsp;          lastLang = lang.getTranslatedName(messages);</b>
&nbsp;//          MessageHandler.printToLogFile(&quot;CheckDialog: findNextError: lang: &quot; + lang.getShortCodeWithCountryAndVariant() + &quot;; translated: &quot; + lastLang);
<b class="nc">&nbsp;          language.setEnabled(true);</b>
<b class="nc">&nbsp;          language.setSelectedItem(lang.getTranslatedName(messages));</b>
<b class="nc">&nbsp;          if (debugMode) {</b>
<b class="nc">&nbsp;            MessageHandler.printToLogFile(&quot;CheckDialog: findNextError: Language set&quot;);</b>
&nbsp;          }
<b class="nc">&nbsp;          Map&lt;String, String&gt; deactivatedRulesMap = documents.getDisabledRulesMap(OfficeTools.localeToString(locale));</b>
<b class="nc">&nbsp;          if (!isSpellError &amp;&amp; !deactivatedRulesMap.isEmpty()) {</b>
<b class="nc">&nbsp;            activateRule.removeAllItems();</b>
<b class="nc">&nbsp;            activateRule.addItem(messages.getString(&quot;loContextMenuActivateRule&quot;));</b>
<b class="nc">&nbsp;            for (String ruleId : deactivatedRulesMap.keySet()) {</b>
<b class="nc">&nbsp;              activateRule.addItem(deactivatedRulesMap.get(ruleId));</b>
<b class="nc">&nbsp;            }</b>
<b class="nc">&nbsp;            activateRule.setVisible(true);</b>
<b class="nc">&nbsp;            activateRule.setEnabled(true);</b>
<b class="nc">&nbsp;            autoCorrect.setVisible(false);</b>
&nbsp;          } else {
<b class="nc">&nbsp;            activateRule.setVisible(false);</b>
<b class="nc">&nbsp;            autoCorrect.setVisible(true);</b>
<b class="nc">&nbsp;            autoCorrect.setEnabled(false);</b>
&nbsp;          }
&nbsp;          
<b class="nc">&nbsp;          if (isSpellError) {</b>
<b class="nc">&nbsp;            ignoreAll.setText(ignoreAllButtonName);</b>
<b class="nc">&nbsp;            addToDictionary.setVisible(true);</b>
<b class="nc">&nbsp;            deactivateRule.setVisible(false);</b>
<b class="nc">&nbsp;            addToDictionary.setEnabled(true);</b>
<b class="nc">&nbsp;            changeAll.setEnabled(true);</b>
<b class="nc">&nbsp;            autoCorrect.setEnabled(true);</b>
&nbsp;          } else {
<b class="nc">&nbsp;            ignoreAll.setText(ignoreRuleButtonName);</b>
<b class="nc">&nbsp;            addToDictionary.setVisible(false);</b>
<b class="nc">&nbsp;            changeAll.setEnabled(false);</b>
<b class="nc">&nbsp;            deactivateRule.setVisible(true);</b>
<b class="nc">&nbsp;            deactivateRule.setEnabled(true);</b>
<b class="nc">&nbsp;            autoCorrect.setEnabled(false);</b>
&nbsp;          }
<b class="nc">&nbsp;          informationUrl = getUrl(error);</b>
<b class="nc">&nbsp;          more.setEnabled(informationUrl != null);</b>
<b class="nc">&nbsp;          undo.setEnabled(undoList != null &amp;&amp; !undoList.isEmpty());</b>
<b class="nc">&nbsp;          if (debugMode) {</b>
<b class="nc">&nbsp;            MessageHandler.printToLogFile(&quot;CheckDialog: findNextError: All set&quot;);</b>
&nbsp;          }
<b class="nc">&nbsp;        } else {</b>
<b class="nc">&nbsp;          language.setEnabled(true);</b>
<b class="nc">&nbsp;          Language lang = locale == null || !documents.hasLocale(locale)? lt.getLanguage() : documents.getLanguage(locale);</b>
<b class="nc">&nbsp;          language.setSelectedItem(lang.getTranslatedName(messages));</b>
<b class="nc">&nbsp;          language.setEnabled(false);</b>
<b class="nc">&nbsp;          more.setEnabled(false);</b>
<b class="nc">&nbsp;          ignoreOnce.setEnabled(false);</b>
<b class="nc">&nbsp;          ignoreAll.setEnabled(false);</b>
<b class="nc">&nbsp;          addToDictionary.setVisible(true);</b>
<b class="nc">&nbsp;          addToDictionary.setEnabled(false);</b>
<b class="nc">&nbsp;          deactivateRule.setVisible(false);</b>
<b class="nc">&nbsp;          changeAll.setEnabled(false);</b>
<b class="nc">&nbsp;          activateRule.setVisible(false);</b>
<b class="nc">&nbsp;          autoCorrect.setVisible(true);</b>
<b class="nc">&nbsp;          autoCorrect.setEnabled(false);</b>
<b class="nc">&nbsp;          focusLost = false;</b>
<b class="nc">&nbsp;          suggestions.setEnabled(true);;</b>
<b class="nc">&nbsp;          suggestions.setListData(new String[0]);</b>
<b class="nc">&nbsp;          undo.setEnabled(undoList != null &amp;&amp; !undoList.isEmpty());</b>
<b class="nc">&nbsp;          errorDescription.setEnabled(true);</b>
<b class="nc">&nbsp;          errorDescription.setForeground(Color.RED);</b>
<b class="nc">&nbsp;          errorDescription.setText(endOfDokumentMessage == null ? &quot;&quot; : endOfDokumentMessage);</b>
<b class="nc">&nbsp;          errorDescription.setBackground(Color.white);</b>
<b class="nc">&nbsp;          sentenceIncludeError.setEnabled(true);</b>
<b class="nc">&nbsp;          sentenceIncludeError.setText(&quot;&quot;);</b>
<b class="nc">&nbsp;          errorDescription.setEnabled(true);</b>
<b class="nc">&nbsp;          change.setEnabled(false);</b>
<b class="nc">&nbsp;          if (docCache.size() &gt; 0) {</b>
<b class="nc">&nbsp;            locale = docCache.getFlatParagraphLocale(docCache.size() - 1);</b>
&nbsp;          }
<b class="nc">&nbsp;          sentenceIncludeError.setEnabled(false);</b>
&nbsp;        }
<b class="nc">&nbsp;      } catch (Throwable e) {</b>
<b class="nc">&nbsp;        MessageHandler.showError(e);</b>
<b class="nc">&nbsp;        closeDialog();</b>
<b class="nc">&nbsp;      }</b>
<b class="nc">&nbsp;      atWork = false;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * stores the list of local dictionaries into the dialog element
&nbsp;     */
&nbsp;    private void setUserDictionaries () {
<b class="nc">&nbsp;      String[] tmpDictionaries = documents.getLtDictionary().getUserDictionaries(xContext);</b>
<b class="nc">&nbsp;      userDictionaries = new String[tmpDictionaries.length + 1];</b>
<b class="nc">&nbsp;      userDictionaries[0] = addToDictionaryName;</b>
<b class="nc">&nbsp;      for (int i = 0; i &lt; tmpDictionaries.length; i++) {</b>
<b class="nc">&nbsp;        userDictionaries[i + 1] = tmpDictionaries[i];</b>
&nbsp;      }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * returns an array of the translated names of the languages supported by LT
&nbsp;     */
&nbsp;    private String[] getPossibleLanguages() {
<b class="nc">&nbsp;      List&lt;String&gt; languages = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;      for (Language lang : Languages.get()) {</b>
<b class="nc">&nbsp;        languages.add(lang.getTranslatedName(messages));</b>
<b class="nc">&nbsp;        languages.sort(null);</b>
<b class="nc">&nbsp;      }</b>
<b class="nc">&nbsp;      return languages.toArray(new String[languages.size()]);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * returns the locale from a translated language name 
&nbsp;     */
&nbsp;    private Locale getLocaleFromLanguageName(String translatedName) {
<b class="nc">&nbsp;      for (Language lang : Languages.get()) {</b>
<b class="nc">&nbsp;        if (translatedName.equals(lang.getTranslatedName(messages))) {</b>
<b class="nc">&nbsp;          return (LinguisticServices.getLocale(lang));</b>
&nbsp;        }
<b class="nc">&nbsp;      }</b>
<b class="nc">&nbsp;      return null;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * set the attributes for the text inside the editor element
&nbsp;     */
&nbsp;    private void setAttributesForErrorText(SingleProofreadingError error) {
&nbsp;      //  Get Attributes
<b class="nc">&nbsp;      sentenceIncludeError.setEnabled(true);</b>
<b class="nc">&nbsp;      MutableAttributeSet attrs = sentenceIncludeError.getInputAttributes();</b>
<b class="nc">&nbsp;      StyledDocument doc = sentenceIncludeError.getStyledDocument();</b>
&nbsp;      //  Set back to default values
<b class="nc">&nbsp;      StyleConstants.setBold(attrs, false);</b>
<b class="nc">&nbsp;      StyleConstants.setUnderline(attrs, false);</b>
<b class="nc">&nbsp;      StyleConstants.setForeground(attrs, defaultForeground);</b>
<b class="nc">&nbsp;      doc.setCharacterAttributes(0, doc.getLength() + 1, attrs, true);</b>
&nbsp;      //  Set values for error
<b class="nc">&nbsp;      StyleConstants.setBold(attrs, true);</b>
<b class="nc">&nbsp;      StyleConstants.setUnderline(attrs, true);</b>
<b class="nc">&nbsp;      Color color = null;</b>
<b class="nc">&nbsp;      if (isSpellError) {</b>
<b class="nc">&nbsp;        color = Color.RED;</b>
&nbsp;      } else {
<b class="nc">&nbsp;        PropertyValue[] properties = error.aProperties;</b>
<b class="nc">&nbsp;        for (PropertyValue property : properties) {</b>
<b class="nc">&nbsp;          if (&quot;LineColor&quot;.equals(property.Name)) {</b>
<b class="nc">&nbsp;            color = new Color((int) property.Value);</b>
<b class="nc">&nbsp;            break;</b>
&nbsp;          }
&nbsp;        }
<b class="nc">&nbsp;        if (color == null) {</b>
<b class="nc">&nbsp;          color = Color.BLUE;</b>
&nbsp;        }
&nbsp;      }
<b class="nc">&nbsp;      StyleConstants.setForeground(attrs, color);</b>
<b class="nc">&nbsp;      doc.setCharacterAttributes(error.nErrorStart, error.nErrorLength, attrs, true);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * returns the URL to more information of match
&nbsp;     * returns null, if such an URL does not exist
&nbsp;     */
&nbsp;    private String getUrl(SingleProofreadingError error) {
<b class="nc">&nbsp;      if (!isSpellError) {</b>
<b class="nc">&nbsp;        PropertyValue[] properties = error.aProperties;</b>
<b class="nc">&nbsp;        for (PropertyValue property : properties) {</b>
<b class="nc">&nbsp;          if (&quot;FullCommentURL&quot;.equals(property.Name)) {</b>
<b class="nc">&nbsp;            String url = new String((String) property.Value);</b>
<b class="nc">&nbsp;            return url;</b>
&nbsp;          }
&nbsp;        }
&nbsp;      }
<b class="nc">&nbsp;      return null;</b>
&nbsp;    }
&nbsp;
&nbsp;   /**
&nbsp;     * returns the next match
&nbsp;     * starting at the current cursor position
&nbsp;     * @throws Throwable 
&nbsp;     */
&nbsp;    private CheckError getNextError(boolean startAtBegin) throws Throwable {
<b class="nc">&nbsp;      if (docType != DocumentType.WRITER) {</b>
<b class="nc">&nbsp;        currentDocument = getCurrentDocument(false);</b>
&nbsp;      }
<b class="nc">&nbsp;      if (currentDocument == null) {</b>
<b class="nc">&nbsp;        MessageHandler.printToLogFile(&quot;CheckDialog: getNextError: currentDocument == null: close dialog&quot;);</b>
<b class="nc">&nbsp;        MessageHandler.showMessage(messages.getString(&quot;loDialogErrorCloseMessage&quot;));</b>
<b class="nc">&nbsp;        closeDialog();</b>
<b class="nc">&nbsp;        return null;</b>
&nbsp;      }
<b class="nc">&nbsp;      XComponent xComponent = currentDocument.getXComponent();</b>
<b class="nc">&nbsp;      DocumentCursorTools docCursor = new DocumentCursorTools(xComponent);</b>
<b class="nc">&nbsp;      if (docCache.size() &lt;= 0) {</b>
<b class="nc">&nbsp;        MessageHandler.printToLogFile(&quot;CheckDialog: getNextError: docCache size == 0: close dialog&quot;);</b>
<b class="nc">&nbsp;        MessageHandler.showMessage(messages.getString(&quot;loDialogErrorCloseMessage&quot;));</b>
<b class="nc">&nbsp;        closeDialog();</b>
<b class="nc">&nbsp;        return null;</b>
&nbsp;      }
<b class="nc">&nbsp;      if (docType == DocumentType.WRITER) {</b>
<b class="nc">&nbsp;        TextParagraph tPara = viewCursor.getViewCursorParagraph();</b>
<b class="nc">&nbsp;        y = docCache.getFlatParagraphNumber(tPara);</b>
&nbsp;//        MessageHandler.printToLogFile(&quot;CheckDialog: getNextError: TextParagraph(type/number): &quot; + tPara.type + &quot; / &quot; + tPara.number 
&nbsp;//            + &quot;; flat: &quot; + y);
<b class="nc">&nbsp;      } else if (docType == DocumentType.IMPRESS) {</b>
<b class="nc">&nbsp;        y = OfficeDrawTools.getParagraphFromCurrentPage(xComponent);</b>
&nbsp;      } else {
<b class="nc">&nbsp;        y = OfficeSpreadsheetTools.getParagraphFromCurrentSheet(xComponent);</b>
&nbsp;      }
<b class="nc">&nbsp;      if (y &lt; 0 || y &gt;= docCache.size()) {</b>
<b class="nc">&nbsp;        MessageHandler.printToLogFile(&quot;CheckDialog: getNextError: y (= &quot; + y + &quot;) &gt;= text size (= &quot; + docCache.size() + &quot;): close dialog&quot;);</b>
<b class="nc">&nbsp;        MessageHandler.showMessage(messages.getString(&quot;loDialogErrorCloseMessage&quot;));</b>
<b class="nc">&nbsp;        closeDialog();</b>
<b class="nc">&nbsp;        return null;</b>
&nbsp;      }
<b class="nc">&nbsp;      if (lastPara &lt; 0) {</b>
<b class="nc">&nbsp;        lastPara = y;</b>
&nbsp;      }
<b class="nc">&nbsp;      if (debugMode) {</b>
<b class="nc">&nbsp;        MessageHandler.printToLogFile(&quot;CheckDialog: getNextError: (x/y): (&quot; + x + &quot;/&quot; + y + &quot;) &lt; text size (= &quot; + docCache.size() + &quot;)&quot;);</b>
&nbsp;      }
<b class="nc">&nbsp;      if (endOfRange &gt;= 0 &amp;&amp; y == lastPara) {</b>
<b class="nc">&nbsp;        x = startOfRange;</b>
&nbsp;      } else {
<b class="nc">&nbsp;        x = 0;</b>
&nbsp;      }
<b class="nc">&nbsp;      int nStart = 0;</b>
<b class="nc">&nbsp;      for (int i = lastPara; i &lt; y &amp;&amp; i &lt; docCache.size(); i++) {</b>
<b class="nc">&nbsp;        nStart += docCache.getFlatParagraph(i).length() + 1;</b>
&nbsp;      }
<b class="nc">&nbsp;      checkProgress.setMaximum(endOfRange &lt; 0 ? docCache.size() : endOfRange);</b>
<b class="nc">&nbsp;      CheckError nextError = null;</b>
<b class="nc">&nbsp;      while (y &lt; docCache.size() &amp;&amp; y &gt;= lastPara &amp;&amp; nextError == null &amp;&amp; (endOfRange &lt; 0 || nStart &lt; endOfRange)) {</b>
<b class="nc">&nbsp;        setProgressValue(endOfRange &lt; 0 ? y - lastPara : nStart + (lastY == y ? lastX : 0), endOfRange &lt; 0);</b>
<b class="nc">&nbsp;        nextError = getNextErrorInParagraph (x, y, currentDocument, docCursor, true);</b>
<b class="nc">&nbsp;        if (debugMode) {</b>
<b class="nc">&nbsp;          MessageHandler.printToLogFile(&quot;CheckDialog: getNextError: endOfRange = &quot; + endOfRange + &quot;, startOfRange = &quot; </b>
&nbsp;                + startOfRange + &quot;, nStart = &quot; + nStart + &quot;, lastX = &quot; + lastX);
&nbsp;        }
<b class="nc">&nbsp;        int pLength = docCache.getFlatParagraph(y).length() + 1;</b>
<b class="nc">&nbsp;        nStart += pLength;</b>
<b class="nc">&nbsp;        if (nextError != null &amp;&amp; (endOfRange &lt; 0 || nStart - pLength + nextError.error.nErrorStart &lt; endOfRange)) {</b>
<b class="nc">&nbsp;          if (nextError.error.aRuleIdentifier.equals(spellRuleId)) {</b>
<b class="nc">&nbsp;            wrongWord = docCache.getFlatParagraph(y).substring(nextError.error.nErrorStart, </b>
&nbsp;                nextError.error.nErrorStart + nextError.error.nErrorLength);
&nbsp;          }
<b class="nc">&nbsp;          if (debugMode) {</b>
<b class="nc">&nbsp;            MessageHandler.printToLogFile(&quot;CheckDialog: getNextError: endOfRange: &quot; + endOfRange + &quot;; ErrorStart(&quot; + nStart </b>
&nbsp;                + &quot;/&quot; + pLength + &quot;/&quot; 
&nbsp;                + nextError.error.nErrorStart + &quot;): &quot; + (nStart - pLength + nextError.error.nErrorStart));
<b class="nc">&nbsp;            MessageHandler.printToLogFile(&quot;CheckDialog: getNextError: x: &quot; + x + &quot;; y: &quot; + y);</b>
&nbsp;          }
<b class="nc">&nbsp;          setFlatViewCursor(nextError.error.nErrorStart, y, nextError.error, viewCursor);</b>
<b class="nc">&nbsp;          lastX = nextError.error.nErrorStart;</b>
<b class="nc">&nbsp;          lastY = y;</b>
<b class="nc">&nbsp;          if (debugMode) {</b>
<b class="nc">&nbsp;            MessageHandler.printToLogFile(&quot;CheckDialog: getNextError: FlatViewCursor set&quot;);</b>
&nbsp;          }
&nbsp;//          loopRuns = false;
<b class="nc">&nbsp;          return nextError;</b>
<b class="nc">&nbsp;        } else if (debugMode) {</b>
<b class="nc">&nbsp;          MessageHandler.printToLogFile(&quot;CheckDialog: getNextError: Next Error = &quot; + (nextError == null ? &quot;null&quot; : nextError.error.nErrorStart) </b>
&nbsp;              + &quot;, endOfRange: &quot; + endOfRange + &quot;; x: &quot; + x + &quot;; y: &quot; + y);
&nbsp;        }
<b class="nc">&nbsp;        y++;</b>
<b class="nc">&nbsp;        x = 0;</b>
<b class="nc">&nbsp;      }</b>
<b class="nc">&nbsp;      if (endOfRange &lt; 0) {</b>
<b class="nc">&nbsp;        if (y == docCache.size()) {</b>
<b class="nc">&nbsp;          y = 0;</b>
&nbsp;        }
<b class="nc">&nbsp;        while (y &lt; lastPara) {</b>
&nbsp;//          checkProgress.setValue(docCache.size() + y - lastPara);
<b class="nc">&nbsp;          setProgressValue(docCache.size() + y - lastPara, true);</b>
&nbsp;//          progressWindow.setValue(docCache.size() + y - lastPara);
<b class="nc">&nbsp;          nextError = getNextErrorInParagraph (0, y, currentDocument, docCursor, true);</b>
<b class="nc">&nbsp;          if (nextError != null) {</b>
<b class="nc">&nbsp;            if (nextError.error.aRuleIdentifier.equals(spellRuleId)) {</b>
<b class="nc">&nbsp;              wrongWord = docCache.getFlatParagraph(y).substring(nextError.error.nErrorStart, </b>
&nbsp;                  nextError.error.nErrorStart + nextError.error.nErrorLength);
&nbsp;            }
<b class="nc">&nbsp;            setFlatViewCursor(nextError.error.nErrorStart, y, nextError.error, viewCursor);</b>
<b class="nc">&nbsp;            if (debugMode) {</b>
<b class="nc">&nbsp;              MessageHandler.printToLogFile(&quot;CheckDialog: getNextError: y: &quot; + y + &quot;lastPara: &quot; + lastPara </b>
&nbsp;                  + &quot;, ErrorStart: &quot; + nextError.error.nErrorStart + &quot;, ErrorLength: &quot; + nextError.error.nErrorLength);
&nbsp;            }
&nbsp;//            loopRuns = false;
<b class="nc">&nbsp;            return nextError;</b>
&nbsp;          }
<b class="nc">&nbsp;          y++;</b>
&nbsp;        }
<b class="nc">&nbsp;        endOfDokumentMessage = messages.getString(&quot;guiCheckComplete&quot;);</b>
<b class="nc">&nbsp;        setProgressValue(docCache.size() - 1, true);</b>
&nbsp;      } else {
<b class="nc">&nbsp;        endOfDokumentMessage = messages.getString(&quot;guiSelectionCheckComplete&quot;);</b>
<b class="nc">&nbsp;        setProgressValue(endOfRange - 1, false);</b>
&nbsp;      }
<b class="nc">&nbsp;      lastPara = -1;</b>
<b class="nc">&nbsp;      if (debugMode) {</b>
<b class="nc">&nbsp;        MessageHandler.printToLogFile(&quot;CheckDialog: getNextError: Error == null, y: &quot; + y + &quot;; lastPara: &quot; + lastPara);</b>
&nbsp;      }
&nbsp;//      loopRuns = false;
<b class="nc">&nbsp;      return null;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Actions of buttons
&nbsp;     */
&nbsp;    @Override
&nbsp;    public void actionPerformed(ActionEvent action) {
<b class="nc">&nbsp;      if (!atWork) {</b>
&nbsp;        try {
<b class="nc">&nbsp;          if (debugMode) {</b>
<b class="nc">&nbsp;            MessageHandler.printToLogFile(&quot;CheckDialog: actionPerformed: Action: &quot; + action.getActionCommand());</b>
&nbsp;          }
<b class="nc">&nbsp;          if (action.getActionCommand().equals(&quot;close&quot;)) {</b>
<b class="nc">&nbsp;            closeDialog();</b>
<b class="nc">&nbsp;          } else if (action.getActionCommand().equals(&quot;more&quot;)) {</b>
<b class="nc">&nbsp;            Tools.openURL(informationUrl);</b>
<b class="nc">&nbsp;          } else if (action.getActionCommand().equals(&quot;options&quot;)) {</b>
<b class="nc">&nbsp;            documents.runOptionsDialog();</b>
<b class="nc">&nbsp;          } else if (action.getActionCommand().equals(&quot;help&quot;)) {</b>
<b class="nc">&nbsp;            MessageHandler.showMessage(messages.getString(&quot;loDialogHelpText&quot;));</b>
&nbsp;          } else {
<b class="nc">&nbsp;            Thread t = new Thread(new Runnable() {</b>
&nbsp;              public void run() {
&nbsp;                try {
<b class="nc">&nbsp;                  if (action.getActionCommand().equals(&quot;ignoreOnce&quot;)) {</b>
<b class="nc">&nbsp;                  setAtWorkButtonState();</b>
<b class="nc">&nbsp;                  ignoreOnce();</b>
<b class="nc">&nbsp;                  } else if (action.getActionCommand().equals(&quot;ignoreAll&quot;)) {</b>
<b class="nc">&nbsp;                    setAtWorkButtonState();</b>
<b class="nc">&nbsp;                    ignoreAll();</b>
<b class="nc">&nbsp;                  } else if (action.getActionCommand().equals(&quot;deactivateRule&quot;)) {</b>
<b class="nc">&nbsp;                    setAtWorkButtonState();</b>
<b class="nc">&nbsp;                    deactivateRule();</b>
<b class="nc">&nbsp;                  } else if (action.getActionCommand().equals(&quot;change&quot;)) {</b>
<b class="nc">&nbsp;                    setAtWorkButtonState();</b>
<b class="nc">&nbsp;                    changeText();</b>
<b class="nc">&nbsp;                  } else if (action.getActionCommand().equals(&quot;changeAll&quot;)) {</b>
<b class="nc">&nbsp;                    setAtWorkButtonState();</b>
<b class="nc">&nbsp;                    changeAll();</b>
<b class="nc">&nbsp;                  } else if (action.getActionCommand().equals(&quot;autoCorrect&quot;)) {</b>
<b class="nc">&nbsp;                    setAtWorkButtonState();</b>
<b class="nc">&nbsp;                    autoCorrect();</b>
<b class="nc">&nbsp;                  } else if (action.getActionCommand().equals(&quot;undo&quot;)) {</b>
<b class="nc">&nbsp;                    setAtWorkButtonState();</b>
<b class="nc">&nbsp;                    undo();</b>
&nbsp;                  } else {
<b class="nc">&nbsp;                    MessageHandler.showMessage(&quot;Action &#39;&quot; + action.getActionCommand() + &quot;&#39; not supported&quot;);</b>
&nbsp;                  }
<b class="nc">&nbsp;                } catch (Throwable e) {</b>
<b class="nc">&nbsp;                  MessageHandler.showError(e);</b>
<b class="nc">&nbsp;                  closeDialog();</b>
<b class="nc">&nbsp;                }</b>
&nbsp;              }
&nbsp;            });
<b class="nc">&nbsp;            t.start();</b>
&nbsp;          }
<b class="nc">&nbsp;        } catch (Throwable e) {</b>
<b class="nc">&nbsp;          MessageHandler.showError(e);</b>
<b class="nc">&nbsp;          closeDialog();</b>
<b class="nc">&nbsp;        }</b>
&nbsp;      }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * closes the dialog
&nbsp;     */
&nbsp;    public void closeDialog() {
<b class="nc">&nbsp;      removeMarkups();</b>
<b class="nc">&nbsp;      dialog.setVisible(false);</b>
<b class="nc">&nbsp;      if (debugMode) {</b>
<b class="nc">&nbsp;        MessageHandler.printToLogFile(&quot;CheckDialog: closeDialog: Close Spell And Grammar Check Dialog&quot;);</b>
&nbsp;      }
<b class="nc">&nbsp;      undoList.clear();</b>
<b class="nc">&nbsp;      documents.setLtDialog(null);</b>
<b class="nc">&nbsp;      documents.setLtDialogIsRunning(false);</b>
<b class="nc">&nbsp;      atWork = false;</b>
&nbsp;//      loopRuns = false;
&nbsp;    }
&nbsp;    
&nbsp;    /**
&nbsp;     * remove a mark for spelling error in document
&nbsp;     * TODO: The function works very temporarily
&nbsp;     */
&nbsp;    private void removeSpellingMark(int nFlat) throws Throwable {
<b class="nc">&nbsp;      XParagraphCursor pCursor = viewCursor.getParagraphCursorFromViewCursor();</b>
<b class="nc">&nbsp;      pCursor.gotoStartOfParagraph(false);</b>
<b class="nc">&nbsp;      pCursor.goRight((short)error.nErrorStart, false);</b>
<b class="nc">&nbsp;      pCursor.goRight((short)error.nErrorLength, true);</b>
<b class="nc">&nbsp;      XMarkingAccess xMarkingAccess = UnoRuntime.queryInterface(XMarkingAccess.class, pCursor);</b>
<b class="nc">&nbsp;      if (xMarkingAccess == null) {</b>
<b class="nc">&nbsp;        MessageHandler.printToLogFile(&quot;CheckDialog: removeSpellingMark: xMarkingAccess == null&quot;);</b>
&nbsp;      } else {
<b class="nc">&nbsp;        xMarkingAccess.invalidateMarkings(TextMarkupType.SPELLCHECK);</b>
&nbsp;      }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * set the information to ignore just the match at the given position
&nbsp;     * @throws Throwable 
&nbsp;     */
&nbsp;    private void ignoreOnce() throws Throwable {
<b class="nc">&nbsp;      x = error.nErrorStart;</b>
<b class="nc">&nbsp;      if (isSpellError &amp;&amp; docType == DocumentType.WRITER) {</b>
<b class="nc">&nbsp;          removeSpellingMark(y);</b>
&nbsp;      }
<b class="nc">&nbsp;      currentDocument.setIgnoredMatch(x, y, error.aRuleIdentifier, true);</b>
<b class="nc">&nbsp;      addUndo(x, y, &quot;ignoreOnce&quot;, error.aRuleIdentifier);</b>
<b class="nc">&nbsp;      gotoNextError();</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * ignore all performed:
&nbsp;     * spelling error: add word to temporary dictionary
&nbsp;     * grammatical error: deactivate rule
&nbsp;     * both actions are only for the current session
&nbsp;     * @throws Throwable 
&nbsp;     */
&nbsp;    private void ignoreAll() throws Throwable {
<b class="nc">&nbsp;      if (isSpellError) {</b>
<b class="nc">&nbsp;        if (debugMode) {</b>
<b class="nc">&nbsp;          MessageHandler.printToLogFile(&quot;CheckDialog: ignoreAll: Ignored word: &quot; + wrongWord);</b>
&nbsp;        }
<b class="nc">&nbsp;        documents.getLtDictionary().addIgnoredWord(wrongWord);</b>
&nbsp;      } else {
<b class="nc">&nbsp;        documents.ignoreRule(error.aRuleIdentifier, locale);</b>
<b class="nc">&nbsp;        documents.initDocuments(true);</b>
<b class="nc">&nbsp;        documents.resetDocument();</b>
<b class="nc">&nbsp;        doInit = true;</b>
&nbsp;      }
<b class="nc">&nbsp;      addUndo(y, &quot;ignoreAll&quot;, error.aRuleIdentifier);</b>
<b class="nc">&nbsp;      gotoNextError();</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * the rule is deactivated permanently (saved in the configuration file)
&nbsp;     * @throws Throwable 
&nbsp;     */
&nbsp;    private void deactivateRule() throws Throwable {
<b class="nc">&nbsp;      if (!isSpellError) {</b>
<b class="nc">&nbsp;        documents.deactivateRule(error.aRuleIdentifier, OfficeTools.localeToString(locale), false);</b>
<b class="nc">&nbsp;        addUndo(y, &quot;deactivateRule&quot;, error.aRuleIdentifier);</b>
<b class="nc">&nbsp;        doInit = true;</b>
&nbsp;      }
<b class="nc">&nbsp;      gotoNextError();</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * compares two strings from the beginning
&nbsp;     * returns the first different character 
&nbsp;     */
&nbsp;    private int getDifferenceFromBegin(String text1, String text2) {
<b class="nc">&nbsp;      for (int i = 0; i &lt; text1.length() &amp;&amp; i &lt; text2.length(); i++) {</b>
<b class="nc">&nbsp;        if (text1.charAt(i) != text2.charAt(i)) {</b>
<b class="nc">&nbsp;          return i;</b>
&nbsp;        }
&nbsp;      }
<b class="nc">&nbsp;      return (text1.length() &lt; text2.length() ? text1.length() : text2.length());</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * compares two strings from the end
&nbsp;     * returns the first different character 
&nbsp;     */
&nbsp;    private int getDifferenceFromEnd(String text1, String text2) {
<b class="nc">&nbsp;      for (int i = 1; i &lt;= text1.length() &amp;&amp; i &lt;= text2.length(); i++) {</b>
<b class="nc">&nbsp;        if (text1.charAt(text1.length() - i) != text2.charAt(text2.length() - i)) {</b>
<b class="nc">&nbsp;          return text1.length() - i + 1;</b>
&nbsp;        }
&nbsp;      }
<b class="nc">&nbsp;      return (text1.length() &lt; text2.length() ? 0 : text1.length() - text2.length());</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * change the text of the paragraph inside the document
&nbsp;     * use the difference between the original paragraph and the text inside the editor element
&nbsp;     * or if there is no difference replace the match by the selected suggestion
&nbsp;     * @throws Throwable 
&nbsp;     */
&nbsp;    private void changeText() throws Throwable {
<b class="nc">&nbsp;      String word = &quot;&quot;;</b>
<b class="nc">&nbsp;      String replace = &quot;&quot;;</b>
&nbsp;      String orgText;
<b class="nc">&nbsp;      if (debugMode) {</b>
<b class="nc">&nbsp;        MessageHandler.printToLogFile(&quot;CheckDialog: changeText entered - docType: &quot; + docType);</b>
&nbsp;      }
<b class="nc">&nbsp;      String dialogText = sentenceIncludeError.getText();</b>
<b class="nc">&nbsp;      if (debugMode) {</b>
<b class="nc">&nbsp;        MessageHandler.printToLogFile(&quot;CheckDialog: changeText: dialog text: &quot; + dialogText);</b>
&nbsp;      }
<b class="nc">&nbsp;      if (docType != DocumentType.WRITER) {</b>
<b class="nc">&nbsp;        orgText = docCache.getFlatParagraph(y);</b>
<b class="nc">&nbsp;        if (!orgText.equals(dialogText)) {</b>
<b class="nc">&nbsp;          int firstChange = getDifferenceFromBegin(orgText, dialogText);</b>
<b class="nc">&nbsp;          int lastEqual = getDifferenceFromEnd(orgText, dialogText);</b>
<b class="nc">&nbsp;          if (lastEqual &lt; firstChange) {</b>
<b class="nc">&nbsp;            lastEqual = firstChange;</b>
&nbsp;          }
<b class="nc">&nbsp;          int lastDialogEqual = dialogText.length() - orgText.length() + lastEqual;</b>
<b class="nc">&nbsp;          word = orgText.substring(firstChange, lastEqual);</b>
<b class="nc">&nbsp;          replace = dialogText.substring(firstChange, lastDialogEqual);</b>
<b class="nc">&nbsp;          changeTextOfParagraph(y, firstChange, lastEqual - firstChange, replace, currentDocument, viewCursor);</b>
<b class="nc">&nbsp;          addSingleChangeUndo(firstChange, y, word, replace);</b>
<b class="nc">&nbsp;        } else if (suggestions.getComponentCount() &gt; 0) {</b>
<b class="nc">&nbsp;          word = orgText.substring(error.nErrorStart, error.nErrorStart + error.nErrorLength);</b>
<b class="nc">&nbsp;          replace = suggestions.getSelectedValue();</b>
<b class="nc">&nbsp;          changeTextOfParagraph(y, error.nErrorStart, error.nErrorLength, replace, currentDocument, viewCursor);</b>
<b class="nc">&nbsp;          addSingleChangeUndo(error.nErrorStart, y, word, replace);</b>
&nbsp;        } else {
<b class="nc">&nbsp;          MessageHandler.printToLogFile(&quot;CheckDialog: changeText: No text selected to change&quot;);</b>
&nbsp;          return;
&nbsp;        }
&nbsp;      } else {
<b class="nc">&nbsp;        orgText = docCache.getFlatParagraph(y);</b>
<b class="nc">&nbsp;        if (debugMode) {</b>
<b class="nc">&nbsp;          MessageHandler.printToLogFile(&quot;CheckDialog: changeText: original text: &quot; + orgText);</b>
&nbsp;        }
<b class="nc">&nbsp;        if (!orgText.equals(dialogText)) {</b>
<b class="nc">&nbsp;          int firstChange = getDifferenceFromBegin(orgText, dialogText);</b>
<b class="nc">&nbsp;          if (debugMode) {</b>
<b class="nc">&nbsp;            MessageHandler.printToLogFile(&quot;CheckDialog: changeText: firstChange: &quot; + firstChange);</b>
&nbsp;          }
<b class="nc">&nbsp;          int lastEqual = getDifferenceFromEnd(orgText, dialogText);</b>
<b class="nc">&nbsp;          if (lastEqual &lt; firstChange) {</b>
<b class="nc">&nbsp;            lastEqual = firstChange;</b>
&nbsp;          }
<b class="nc">&nbsp;          if (debugMode) {</b>
<b class="nc">&nbsp;            MessageHandler.printToLogFile(&quot;CheckDialog: changeText: lastEqual: &quot; + lastEqual);</b>
&nbsp;          }
<b class="nc">&nbsp;          int lastDialogEqual = dialogText.length() - orgText.length() + lastEqual;</b>
<b class="nc">&nbsp;          if (debugMode) {</b>
<b class="nc">&nbsp;            MessageHandler.printToLogFile(&quot;CheckDialog: changeText: lastDialogEqual: &quot; + lastDialogEqual);</b>
&nbsp;          }
<b class="nc">&nbsp;          if (firstChange &lt; lastEqual) {</b>
<b class="nc">&nbsp;            word = orgText.substring(firstChange, lastEqual);</b>
&nbsp;          } else {
<b class="nc">&nbsp;            word =&quot;&quot;;</b>
&nbsp;          }
<b class="nc">&nbsp;          if (firstChange &lt; lastDialogEqual) {</b>
<b class="nc">&nbsp;            replace = dialogText.substring(firstChange, lastDialogEqual);</b>
&nbsp;          } else {
<b class="nc">&nbsp;            replace =&quot;&quot;;</b>
&nbsp;          }
<b class="nc">&nbsp;          if (debugMode) {</b>
<b class="nc">&nbsp;            MessageHandler.printToLogFile(&quot;CheckDialog: changeText: word: &#39;&quot; + word + &quot;&#39;, replace: &#39;&quot; + replace + &quot;&#39;&quot;);</b>
&nbsp;          }
<b class="nc">&nbsp;          changeTextOfParagraph(y, firstChange, lastEqual - firstChange, replace, currentDocument, viewCursor);</b>
<b class="nc">&nbsp;          addSingleChangeUndo(firstChange, y, word, replace);</b>
<b class="nc">&nbsp;        } else if (suggestions.getComponentCount() &gt; 0) {</b>
<b class="nc">&nbsp;          if (orgText.length() &gt;= error.nErrorStart + error.nErrorLength) {</b>
<b class="nc">&nbsp;            word = orgText.substring(error.nErrorStart, error.nErrorStart + error.nErrorLength);</b>
<b class="nc">&nbsp;            replace = suggestions.getSelectedValue();</b>
<b class="nc">&nbsp;            changeTextOfParagraph(y, error.nErrorStart, error.nErrorLength, replace, currentDocument, viewCursor);</b>
<b class="nc">&nbsp;            addSingleChangeUndo(error.nErrorStart, y, word, replace);</b>
&nbsp;          }
&nbsp;        } else {
<b class="nc">&nbsp;          MessageHandler.printToLogFile(&quot;CheckDialog: changeText: No text selected to change&quot;);</b>
&nbsp;          return;
&nbsp;        }
&nbsp;      }
<b class="nc">&nbsp;      if (debugMode) {</b>
<b class="nc">&nbsp;        MessageHandler.printToLogFile(&quot;CheckDialog: changeText: Org: &quot; + word + &quot;\nDia: &quot; + replace);</b>
&nbsp;      }
<b class="nc">&nbsp;      currentDocument = getCurrentDocument(true);</b>
<b class="nc">&nbsp;      gotoNextError();</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Change all matched words of the document by the selected suggestion
&nbsp;     * @throws Throwable 
&nbsp;     */
&nbsp;    private void changeAll() throws Throwable {
<b class="nc">&nbsp;      if (suggestions.getComponentCount() &gt; 0) {</b>
<b class="nc">&nbsp;        String orgText = sentenceIncludeError.getText();</b>
<b class="nc">&nbsp;        String word = orgText.substring(error.nErrorStart, error.nErrorStart + error.nErrorLength);</b>
<b class="nc">&nbsp;        String replace = suggestions.getSelectedValue();</b>
<b class="nc">&nbsp;        XComponent xComponent = currentDocument.getXComponent();</b>
<b class="nc">&nbsp;        DocumentCursorTools docCursor = new DocumentCursorTools(xComponent);</b>
<b class="nc">&nbsp;        Map&lt;Integer, List&lt;Integer&gt;&gt; orgParas = spellChecker.replaceAllWordsInText(word, replace, docCursor, currentDocument, viewCursor);</b>
<b class="nc">&nbsp;        if (orgParas != null) {</b>
<b class="nc">&nbsp;          addChangeUndo(error.nErrorStart, y, word, replace, orgParas);</b>
&nbsp;        }
<b class="nc">&nbsp;        gotoNextError();</b>
&nbsp;      }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Change all matched words of the document by the selected suggestion
&nbsp;     * Add word-suggestion-pair to AutoCorrect
&nbsp;     * @throws Throwable 
&nbsp;     */
&nbsp;    private void autoCorrect() throws Throwable {
<b class="nc">&nbsp;      if (suggestions.getComponentCount() &gt; 0) {</b>
<b class="nc">&nbsp;        String orgText = sentenceIncludeError.getText();</b>
<b class="nc">&nbsp;        String word = orgText.substring(error.nErrorStart, error.nErrorStart + error.nErrorLength);</b>
<b class="nc">&nbsp;        String replace = suggestions.getSelectedValue();</b>
<b class="nc">&nbsp;        XComponent xComponent = currentDocument.getXComponent();</b>
<b class="nc">&nbsp;        DocumentCursorTools docCursor = new DocumentCursorTools(xComponent);</b>
<b class="nc">&nbsp;        Map&lt;Integer, List&lt;Integer&gt;&gt; orgParas = spellChecker.replaceAllWordsInText(word, replace, docCursor, currentDocument, viewCursor);</b>
<b class="nc">&nbsp;        if (orgParas != null) {</b>
<b class="nc">&nbsp;          addChangeUndo(error.nErrorStart, y, word, replace, orgParas);</b>
&nbsp;        }
<b class="nc">&nbsp;        addToAutoCorrect(word, replace);</b>
<b class="nc">&nbsp;        gotoNextError();</b>
&nbsp;      }
&nbsp;    }
&nbsp;    
&nbsp;    /**
&nbsp;     * Add word-suggestion-pair to AutoCorrect
&nbsp;     * @throws Throwable 
&nbsp;     */
&nbsp;    private void addToAutoCorrect(String word, String replace) throws Throwable {
<b class="nc">&nbsp;      XMultiComponentFactory xMCF = UnoRuntime.queryInterface(XMultiComponentFactory.class,</b>
<b class="nc">&nbsp;          xContext.getServiceManager());</b>
<b class="nc">&nbsp;      if (xMCF == null) {</b>
<b class="nc">&nbsp;        MessageHandler.printToLogFile(&quot;Could not get XMultiComponentFactory&quot;);</b>
&nbsp;        return;
&nbsp;      }
<b class="nc">&nbsp;      Object obj = xMCF.createInstanceWithContext(&quot;com.sun.star.util.PathSettings&quot;, xContext);</b>
<b class="nc">&nbsp;      XPropertySet xPathSettings = UnoRuntime.queryInterface(XPropertySet.class, obj);</b>
<b class="nc">&nbsp;      String aCorrPathUri = (String) xPathSettings.getPropertyValue(&quot;AutoCorrect_writable&quot;);</b>
<b class="nc">&nbsp;      URI aCorrUri = new URI(aCorrPathUri);</b>
<b class="nc">&nbsp;      String aCorrFile = aCorrUri.getPath() + &quot;/&quot; + ACORR_PREFIX + locale.Language + &quot;-&quot; + locale.Country + ACORR_SUFFIX;</b>
<b class="nc">&nbsp;      String aCorrTmpFile = aCorrUri.getPath() + &quot;/&quot; + ACORR_PREFIX + locale.Language + &quot;-&quot; + locale.Country + &quot;_tmp&quot; + ACORR_SUFFIX;</b>
<b class="nc">&nbsp;      MessageHandler.printToLogFile(&quot;AutoCorrect path: &quot; + aCorrFile);</b>
<b class="nc">&nbsp;      String tmpDir = aCorrUri.getPath() + &quot;/tmp&quot;;</b>
<b class="nc">&nbsp;      unzipACorr(tmpDir, aCorrFile);</b>
<b class="nc">&nbsp;      addWordPairToCorFile(tmpDir, word, replace);</b>
<b class="nc">&nbsp;      zipACorr(tmpDir, aCorrTmpFile);</b>
<b class="nc">&nbsp;      File tmpDr = new File(tmpDir); </b>
<b class="nc">&nbsp;      deleteFullDirectory(tmpDr);</b>
<b class="nc">&nbsp;      File file = new File(aCorrFile);</b>
<b class="nc">&nbsp;      File newFile = new File(aCorrTmpFile);</b>
<b class="nc">&nbsp;      file.delete();</b>
<b class="nc">&nbsp;      newFile.renameTo(file);</b>
&nbsp;    }
&nbsp;    
&nbsp;    boolean deleteFullDirectory(File directory) {
<b class="nc">&nbsp;      File[] contents = directory.listFiles();</b>
<b class="nc">&nbsp;      if (contents != null) {</b>
<b class="nc">&nbsp;          for (File file : contents) {</b>
<b class="nc">&nbsp;              deleteFullDirectory(file);</b>
&nbsp;          }
&nbsp;      }
<b class="nc">&nbsp;      return directory.delete();</b>
&nbsp;    }
&nbsp;    
&nbsp;    private void unzipACorr(String destDirPath, String zipFilePath) throws IOException {
<b class="nc">&nbsp;      File destDir = new File(destDirPath);</b>
<b class="nc">&nbsp;      if (destDir.exists() &amp;&amp; destDir.isDirectory()) {</b>
<b class="nc">&nbsp;        if(!deleteFullDirectory(destDir)) {</b>
<b class="nc">&nbsp;          throw new IOException(&quot;Failed to remove directory &quot; + destDirPath);</b>
&nbsp;        }
&nbsp;      }
<b class="nc">&nbsp;      if (!destDir.mkdir()) {</b>
<b class="nc">&nbsp;        throw new IOException(&quot;Failed to create directory &quot; + destDirPath);</b>
&nbsp;      }
<b class="nc">&nbsp;      byte[] buffer = new byte[1024];</b>
<b class="nc">&nbsp;      try (ZipInputStream zis = new ZipInputStream(new FileInputStream(zipFilePath))) {</b>
<b class="nc">&nbsp;        ZipEntry zipEntry = zis.getNextEntry();</b>
<b class="nc">&nbsp;        while (zipEntry != null) {</b>
<b class="nc">&nbsp;          File newFile = new File(destDir, zipEntry.getName());</b>
<b class="nc">&nbsp;          if (zipEntry.isDirectory()) {</b>
<b class="nc">&nbsp;            if (!newFile.isDirectory() &amp;&amp; !newFile.mkdirs()) {</b>
<b class="nc">&nbsp;              throw new IOException(&quot;Failed to create directory &quot; + newFile);</b>
&nbsp;            }
&nbsp;          } else {
&nbsp;            // fix for Windows-created archives
<b class="nc">&nbsp;            File parent = newFile.getParentFile();</b>
<b class="nc">&nbsp;            if (!parent.isDirectory() &amp;&amp; !parent.mkdirs()) {</b>
<b class="nc">&nbsp;              throw new IOException(&quot;Failed to create directory &quot; + parent);</b>
&nbsp;            }
&nbsp;            // write file content
<b class="nc">&nbsp;            FileOutputStream fos = new FileOutputStream(newFile);</b>
&nbsp;            int len;
<b class="nc">&nbsp;            while ((len = zis.read(buffer)) &gt; 0) {</b>
<b class="nc">&nbsp;              fos.write(buffer, 0, len);</b>
&nbsp;            }
<b class="nc">&nbsp;            fos.close();</b>
&nbsp;          }
<b class="nc">&nbsp;          zipEntry = zis.getNextEntry();</b>
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        zis.closeEntry();</b>
<b class="nc">&nbsp;        zis.close();</b>
<b class="nc">&nbsp;      }</b>
&nbsp;    }
&nbsp;    
&nbsp;    private void addWordPairToCorFile(String dirPath, String word, String replace) throws Throwable {
<b class="nc">&nbsp;      String fileName = &quot;DocumentList.xml&quot;;</b>
<b class="nc">&nbsp;      String tmpFileName = &quot;DocumentList_tmp.xml&quot;;</b>
<b class="nc">&nbsp;      File file = new File(dirPath, fileName);</b>
<b class="nc">&nbsp;      File newFile = new File(dirPath, tmpFileName);</b>
<b class="nc">&nbsp;      FileInputStream fis = new FileInputStream(file);</b>
<b class="nc">&nbsp;      FileOutputStream fos = new FileOutputStream(newFile);</b>
<b class="nc">&nbsp;      byte[] buffer = new byte[1024];</b>
&nbsp;      int len;
<b class="nc">&nbsp;      long maxReadLen = file.length() - 24;</b>
<b class="nc">&nbsp;      while (maxReadLen &gt; 0 &amp;&amp; (len = fis.read(buffer)) &gt; 0) {</b>
<b class="nc">&nbsp;        if (len &gt; maxReadLen) {</b>
<b class="nc">&nbsp;          len = (int) maxReadLen;</b>
&nbsp;        }
<b class="nc">&nbsp;        fos.write(buffer, 0, len);</b>
<b class="nc">&nbsp;        maxReadLen -= len;</b>
&nbsp;      }
<b class="nc">&nbsp;      fis.close();</b>
<b class="nc">&nbsp;      String str = &quot;&lt;block-list:block block-list:abbreviated-name=\&quot;&quot; + word + &quot;\&quot; block-list:name=\&quot;&quot; + replace + &quot;\&quot;/&gt;&lt;/block-list:block-list&gt;&quot;;</b>
<b class="nc">&nbsp;      buffer = str.getBytes();</b>
<b class="nc">&nbsp;      len = buffer.length;</b>
<b class="nc">&nbsp;      fos.write(buffer, 0, len);</b>
<b class="nc">&nbsp;      fos.close();</b>
<b class="nc">&nbsp;      file.delete();</b>
<b class="nc">&nbsp;      newFile.renameTo(file);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void zipACorr(String sourceDirPath, String zipFilePath) throws IOException {
<b class="nc">&nbsp;      FileOutputStream fos = new FileOutputStream(zipFilePath);</b>
<b class="nc">&nbsp;      ZipOutputStream zipOut = new ZipOutputStream(fos);</b>
<b class="nc">&nbsp;      File dirToZip = new File(sourceDirPath);</b>
<b class="nc">&nbsp;      File[] children = dirToZip.listFiles();</b>
<b class="nc">&nbsp;      for (File childFile : children) {</b>
<b class="nc">&nbsp;        zipFileRec(childFile, childFile.getName(), zipOut);</b>
&nbsp;      }
<b class="nc">&nbsp;      zipOut.close();</b>
<b class="nc">&nbsp;      fos.close();</b>
&nbsp;    }
&nbsp;    
&nbsp;    private void zipFileRec(File fileToZip, String fileName, ZipOutputStream zipOut) throws IOException {
<b class="nc">&nbsp;      if (fileToZip.isHidden()) {</b>
&nbsp;          return;
&nbsp;      }
<b class="nc">&nbsp;      if (fileToZip.isDirectory()) {</b>
<b class="nc">&nbsp;        if (fileName.endsWith(&quot;/&quot;)) {</b>
<b class="nc">&nbsp;          zipOut.putNextEntry(new ZipEntry(fileName));</b>
<b class="nc">&nbsp;          zipOut.closeEntry();</b>
&nbsp;        } else {
<b class="nc">&nbsp;          zipOut.putNextEntry(new ZipEntry(fileName + &quot;/&quot;));</b>
<b class="nc">&nbsp;          zipOut.closeEntry();</b>
&nbsp;        }
<b class="nc">&nbsp;        File[] children = fileToZip.listFiles();</b>
<b class="nc">&nbsp;        for (File childFile : children) {</b>
<b class="nc">&nbsp;          zipFileRec(childFile, fileName + &quot;/&quot; + childFile.getName(), zipOut);</b>
&nbsp;        }
&nbsp;        return;
&nbsp;      }
<b class="nc">&nbsp;      FileInputStream fis = new FileInputStream(fileToZip);</b>
<b class="nc">&nbsp;      ZipEntry zipEntry = new ZipEntry(fileName);</b>
<b class="nc">&nbsp;      zipOut.putNextEntry(zipEntry);</b>
<b class="nc">&nbsp;      byte[] bytes = new byte[1024];</b>
&nbsp;      int length;
<b class="nc">&nbsp;      while ((length = fis.read(bytes)) &gt;= 0) {</b>
<b class="nc">&nbsp;          zipOut.write(bytes, 0, length);</b>
&nbsp;      }
<b class="nc">&nbsp;      fis.close();</b>
&nbsp;    }
&nbsp;    
&nbsp;    /**
&nbsp;     * Add undo information
&nbsp;     * maxUndos changes are stored in the undo list
&nbsp;     */
&nbsp;    private void addUndo(int y, String action, String ruleId) throws Throwable {
<b class="nc">&nbsp;      addUndo(0, y, action, ruleId);</b>
&nbsp;    }
&nbsp;    
&nbsp;    private void addUndo(int x, int y, String action, String ruleId) throws Throwable {
<b class="nc">&nbsp;      addUndo(x, y, action, ruleId, null);</b>
&nbsp;    }
&nbsp;    
&nbsp;    private void addUndo(int y, String action, String ruleId, String word) throws Throwable {
<b class="nc">&nbsp;      addUndo(0, y, action, ruleId, word, null);</b>
&nbsp;    }
&nbsp;    
&nbsp;    private void addUndo(int x, int y, String action, String ruleId, Map&lt;Integer, List&lt;Integer&gt;&gt; orgParas) throws Throwable {
<b class="nc">&nbsp;      addUndo(x, y, action, ruleId, null, orgParas);</b>
&nbsp;    }
&nbsp;    
&nbsp;    private void addUndo(int x, int y, String action, String ruleId, String word, Map&lt;Integer, List&lt;Integer&gt;&gt; orgParas) throws Throwable {
<b class="nc">&nbsp;      if (undoList.size() &gt;= maxUndos) {</b>
<b class="nc">&nbsp;        undoList.remove(0);</b>
&nbsp;      }
<b class="nc">&nbsp;      undoList.add(new UndoContainer(x, y, action, ruleId, word, orgParas));</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * add undo information for change function (general)
&nbsp;     */
&nbsp;    private void addChangeUndo(int x, int y, String word, String replace, Map&lt;Integer, List&lt;Integer&gt;&gt; orgParas) throws Throwable {
<b class="nc">&nbsp;      addUndo(x, y, &quot;change&quot;, replace, word, orgParas);</b>
&nbsp;    }
&nbsp;    
&nbsp;    /**
&nbsp;     * add undo information for a single change
&nbsp;     * @throws Throwable 
&nbsp;     */
&nbsp;    private void addSingleChangeUndo(int x, int y, String word, String replace) throws Throwable {
<b class="nc">&nbsp;      Map&lt;Integer, List&lt;Integer&gt;&gt; paraMap = new HashMap&lt;Integer, List&lt;Integer&gt;&gt;();</b>
<b class="nc">&nbsp;      List&lt;Integer&gt; xVals = new ArrayList&lt;Integer&gt;();</b>
<b class="nc">&nbsp;      xVals.add(x);</b>
<b class="nc">&nbsp;      paraMap.put(y, xVals);</b>
<b class="nc">&nbsp;      addChangeUndo(x, y, word, replace, paraMap);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * add undo information for a language change
&nbsp;     * @throws Throwable 
&nbsp;     */
&nbsp;    private void addLanguageChangeUndo(int nFlat, int nStart, int nLen, String originalLanguage) throws Throwable {
<b class="nc">&nbsp;      Map&lt;Integer, List&lt;Integer&gt;&gt; paraMap = new HashMap&lt;Integer, List&lt;Integer&gt;&gt;();</b>
<b class="nc">&nbsp;      List&lt;Integer&gt; xVals = new ArrayList&lt;Integer&gt;();</b>
<b class="nc">&nbsp;      xVals.add(nStart);</b>
<b class="nc">&nbsp;      xVals.add(nLen);</b>
<b class="nc">&nbsp;      paraMap.put(nFlat, xVals);</b>
<b class="nc">&nbsp;      addUndo(0, nFlat, &quot;changeLanguage&quot;, originalLanguage, null, paraMap);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * undo the last change triggered by the LT check dialog
&nbsp;     */
&nbsp;    private void undo() throws Throwable {
<b class="nc">&nbsp;      if (undoList == null || undoList.isEmpty()) {</b>
&nbsp;        return;
&nbsp;      }
&nbsp;      try {
<b class="nc">&nbsp;        removeMarkups();</b>
<b class="nc">&nbsp;        int nLastUndo = undoList.size() - 1;</b>
<b class="nc">&nbsp;        UndoContainer lastUndo = undoList.get(nLastUndo);</b>
<b class="nc">&nbsp;        String action = lastUndo.action;</b>
<b class="nc">&nbsp;        int xUndo = lastUndo.x;</b>
<b class="nc">&nbsp;        int yUndo = lastUndo.y;</b>
<b class="nc">&nbsp;        if (debugMode) {</b>
<b class="nc">&nbsp;          MessageHandler.printToLogFile(&quot;CheckDialog: Undo: Action: &quot; + action);</b>
&nbsp;        }
<b class="nc">&nbsp;        if (action.equals(&quot;ignoreOnce&quot;)) {</b>
<b class="nc">&nbsp;          currentDocument.removeIgnoredMatch(xUndo, yUndo, lastUndo.ruleId, true);</b>
<b class="nc">&nbsp;        } else if (action.equals(&quot;ignoreAll&quot;)) {</b>
<b class="nc">&nbsp;          if (lastUndo.ruleId.equals(spellRuleId)) {</b>
<b class="nc">&nbsp;            if (debugMode) {</b>
<b class="nc">&nbsp;              MessageHandler.printToLogFile(&quot;CheckDialog: Undo: Ignored word removed: &quot; + wrongWord);</b>
&nbsp;            }
<b class="nc">&nbsp;            documents.getLtDictionary().removeIgnoredWord(wrongWord);</b>
&nbsp;          } else {
<b class="nc">&nbsp;            Locale locale = docCache.getFlatParagraphLocale(yUndo);</b>
<b class="nc">&nbsp;            documents.removeDisabledRule(OfficeTools.localeToString(locale), lastUndo.ruleId);</b>
<b class="nc">&nbsp;            documents.initDocuments(true);</b>
<b class="nc">&nbsp;            documents.resetDocument();</b>
<b class="nc">&nbsp;            doInit = true;</b>
<b class="nc">&nbsp;          }</b>
<b class="nc">&nbsp;        } else if (action.equals(&quot;deactivateRule&quot;)) {</b>
<b class="nc">&nbsp;          currentDocument.removeResultCache(yUndo);</b>
<b class="nc">&nbsp;          Locale locale = docCache.getFlatParagraphLocale(yUndo);</b>
<b class="nc">&nbsp;          documents.deactivateRule(lastUndo.ruleId, OfficeTools.localeToString(locale), true);</b>
<b class="nc">&nbsp;          doInit = true;</b>
<b class="nc">&nbsp;        } else if (action.equals(&quot;activateRule&quot;)) {</b>
<b class="nc">&nbsp;          currentDocument.removeResultCache(yUndo);</b>
<b class="nc">&nbsp;          Locale locale = docCache.getFlatParagraphLocale(yUndo);</b>
<b class="nc">&nbsp;          documents.deactivateRule(lastUndo.ruleId, OfficeTools.localeToString(locale), false);</b>
<b class="nc">&nbsp;          doInit = true;</b>
<b class="nc">&nbsp;        } else if (action.equals(&quot;addToDictionary&quot;)) {</b>
<b class="nc">&nbsp;          documents.getLtDictionary().removeWordFromDictionary(lastUndo.ruleId, lastUndo.word, xContext);</b>
<b class="nc">&nbsp;        } else if (action.equals(&quot;changeLanguage&quot;)) {</b>
<b class="nc">&nbsp;          Locale locale = getLocaleFromLanguageName(lastUndo.ruleId);</b>
<b class="nc">&nbsp;          FlatParagraphTools flatPara = currentDocument.getFlatParagraphTools();</b>
<b class="nc">&nbsp;          int nFlat = lastUndo.y;</b>
<b class="nc">&nbsp;          int nStart = lastUndo.orgParas.get(nFlat).get(0);</b>
<b class="nc">&nbsp;          int nLen = lastUndo.orgParas.get(nFlat).get(1);</b>
<b class="nc">&nbsp;          if (debugMode) {</b>
<b class="nc">&nbsp;            MessageHandler.printToLogFile(&quot;CheckDialog: Undo: Change Language: Locale: &quot; + locale.Language + &quot;-&quot; + locale.Country </b>
&nbsp;              + &quot;, nFlat = &quot; + nFlat + &quot;, nStart = &quot; + nStart + &quot;, nLen = &quot; + nLen);
&nbsp;          }
<b class="nc">&nbsp;          if (docType == DocumentType.IMPRESS) {</b>
<b class="nc">&nbsp;            OfficeDrawTools.setLanguageOfParagraph(nFlat, nStart, nLen, locale, currentDocument.getXComponent());</b>
<b class="nc">&nbsp;          } else if (docType == DocumentType.CALC) {</b>
<b class="nc">&nbsp;            OfficeSpreadsheetTools.setLanguageOfSpreadsheet(locale, currentDocument.getXComponent());</b>
&nbsp;          } else {
<b class="nc">&nbsp;            flatPara.setLanguageOfParagraph(nFlat, nStart, nLen, locale);</b>
&nbsp;          }
<b class="nc">&nbsp;          if (nLen == docCache.getFlatParagraph(nFlat).length()) {</b>
<b class="nc">&nbsp;            docCache.setFlatParagraphLocale(nFlat, locale);</b>
<b class="nc">&nbsp;            DocumentCache curDocCache = currentDocument.getDocumentCache();</b>
<b class="nc">&nbsp;            if (curDocCache != null) {</b>
<b class="nc">&nbsp;              curDocCache.setFlatParagraphLocale(nFlat, locale);</b>
&nbsp;            }
&nbsp;          }
<b class="nc">&nbsp;          currentDocument.removeResultCache(nFlat);</b>
<b class="nc">&nbsp;        } else if (action.equals(&quot;change&quot;)) {</b>
<b class="nc">&nbsp;          Map&lt;Integer, List&lt;Integer&gt;&gt; paras = lastUndo.orgParas;</b>
<b class="nc">&nbsp;          short length = (short) lastUndo.ruleId.length();</b>
<b class="nc">&nbsp;          for (int nFlat : paras.keySet()) {</b>
<b class="nc">&nbsp;            List&lt;Integer&gt; xStarts = paras.get(nFlat);</b>
<b class="nc">&nbsp;            TextParagraph n = docCache.getNumberOfTextParagraph(nFlat);</b>
<b class="nc">&nbsp;            if (debugMode) {</b>
<b class="nc">&nbsp;              MessageHandler.printToLogFile(&quot;CheckDialog: Undo: Ignore change: nFlat = &quot; + nFlat + &quot;, n = (&quot; + n.type + &quot;,&quot; + n.number + &quot;), x = &quot; + xStarts.get(0));</b>
&nbsp;            }
<b class="nc">&nbsp;            if (docType != DocumentType.WRITER) {</b>
<b class="nc">&nbsp;              for (int i = xStarts.size() - 1; i &gt;= 0; i --) {</b>
<b class="nc">&nbsp;                int xStart = xStarts.get(i);</b>
<b class="nc">&nbsp;                changeTextOfParagraph(nFlat, xStart, length, lastUndo.word, currentDocument, viewCursor);</b>
&nbsp;              }
&nbsp;            } else {
<b class="nc">&nbsp;              String para = docCache.getFlatParagraph(nFlat);</b>
<b class="nc">&nbsp;              for (int i = xStarts.size() - 1; i &gt;= 0; i --) {</b>
<b class="nc">&nbsp;                int xStart = xStarts.get(i);</b>
<b class="nc">&nbsp;                para = para.substring(0, xStart) + lastUndo.word + para.substring(xStart + length);</b>
<b class="nc">&nbsp;                changeTextOfParagraph(nFlat, xStart, length, lastUndo.word, currentDocument, viewCursor);</b>
&nbsp;              }
&nbsp;            }
<b class="nc">&nbsp;            currentDocument.removeResultCache(nFlat);</b>
<b class="nc">&nbsp;          }</b>
<b class="nc">&nbsp;        } else {</b>
<b class="nc">&nbsp;          MessageHandler.showMessage(&quot;Undo &#39;&quot; + action + &quot;&#39; not supported&quot;);</b>
&nbsp;        }
<b class="nc">&nbsp;        undoList.remove(nLastUndo);</b>
<b class="nc">&nbsp;        setFlatViewCursor(xUndo, yUndo, null, viewCursor);</b>
<b class="nc">&nbsp;        if (debugMode) {</b>
<b class="nc">&nbsp;          MessageHandler.printToLogFile(&quot;CheckDialog: Undo: yUndo = &quot; + yUndo + &quot;, xUndo = &quot; + xUndo </b>
&nbsp;              + &quot;, lastPara = &quot; + lastPara);
&nbsp;        }
<b class="nc">&nbsp;        gotoNextError();</b>
<b class="nc">&nbsp;      } catch (Throwable e) {</b>
<b class="nc">&nbsp;        MessageHandler.showError(e);</b>
<b class="nc">&nbsp;        closeDialog();</b>
<b class="nc">&nbsp;      }</b>
&nbsp;    }
&nbsp;
&nbsp;    void setFlatViewCursor(int x, int y, SingleProofreadingError error, ViewCursorTools viewCursor) throws Throwable {
<b class="nc">&nbsp;      this.x = x;</b>
<b class="nc">&nbsp;      this.y = y;</b>
<b class="nc">&nbsp;      if (docType == DocumentType.WRITER) {</b>
<b class="nc">&nbsp;        TextParagraph para = docCache.getNumberOfTextParagraph(y);</b>
<b class="nc">&nbsp;        SpellAndGrammarCheckDialog.setTextViewCursor(x, para, viewCursor);</b>
<b class="nc">&nbsp;      } else if (docType == DocumentType.IMPRESS) {</b>
<b class="nc">&nbsp;        OfficeDrawTools.setCurrentPage(y, currentDocument.getXComponent());</b>
<b class="nc">&nbsp;        if (OfficeDrawTools.isParagraphInNotesPage(y, currentDocument.getXComponent())) {</b>
<b class="nc">&nbsp;          OfficeTools.dispatchCmd(&quot;.uno:NotesMode&quot;, xContext);</b>
&nbsp;          //  Note: a delay interval is needed to put the dialog to front
&nbsp;          try {
<b class="nc">&nbsp;            Thread.sleep(500);</b>
<b class="nc">&nbsp;          } catch (InterruptedException e) {</b>
<b class="nc">&nbsp;            MessageHandler.printException(e);</b>
<b class="nc">&nbsp;          }</b>
<b class="nc">&nbsp;          dialog.toFront();</b>
&nbsp;        }
<b class="nc">&nbsp;        if (error != null) {</b>
&nbsp;//          if (!error.aRuleIdentifier.equals(spellRuleId)) {
&nbsp;//            OfficeDrawTools.removeMarkup(undoMarkup, currentDocument.getXComponent());
<b class="nc">&nbsp;            undoMarkup = new UndoMarkupContainer();</b>
<b class="nc">&nbsp;            OfficeDrawTools.setMarkup(y, error, undoMarkup, currentDocument.getXComponent());</b>
&nbsp;//          }
&nbsp;        }
&nbsp;      } else {
<b class="nc">&nbsp;        OfficeSpreadsheetTools.setCurrentSheet(y, currentDocument.getXComponent());</b>
&nbsp;      }
&nbsp;    }
&nbsp;
&nbsp;    void removeMarkups() {
<b class="nc">&nbsp;      if (docType == DocumentType.IMPRESS &amp;&amp; undoMarkup != null) {</b>
<b class="nc">&nbsp;        OfficeDrawTools.removeMarkup(undoMarkup, currentDocument.getXComponent());</b>
<b class="nc">&nbsp;        undoMarkup = null;</b>
&nbsp;      }
&nbsp;    }
&nbsp;    
&nbsp;  }
&nbsp;/*  
&nbsp;  class ProgressWindow {
&nbsp;    private final static int dialogWidth = 200;
&nbsp;    private final static int dialogHeight = 90;
&nbsp;
&nbsp;    private final JDialog progressDialog;
&nbsp;    private final JProgressBar progressBar;
&nbsp;    private final JLabel printProgress;
&nbsp;    private final int maximum;
&nbsp;    
&nbsp;    ProgressWindow(int maximum) {
&nbsp;      this.maximum = maximum;
&nbsp;      progressDialog = new JDialog();
&nbsp;      progressDialog.setTitle(checkStatusCheck);
&nbsp;      progressDialog.setSize(dialogWidth,dialogHeight);
&nbsp;      progressDialog.setLayout(null);
&nbsp;      progressDialog.setModal(false);
&nbsp;      progressDialog.setDefaultCloseOperation(JDialog.DISPOSE_ON_CLOSE);
&nbsp;      progressBar = new JProgressBar(0, 100);
&nbsp;      progressBar.setStringPainted(true);
&nbsp;      progressBar.setBounds(20, 10, 160, 20);
&nbsp;      progressBar.setMaximum(maximum);
&nbsp;      progressDialog.add(progressBar);
&nbsp;      printProgress = new JLabel(&quot;( 0 / &quot; + maximum + &quot; )&quot;);
&nbsp;      printProgress.setBounds(40, 40, 120, 20);
&nbsp;      Dimension screenSize = Toolkit.getDefaultToolkit().getScreenSize();
&nbsp;      Dimension frameSize = progressDialog.getSize();
&nbsp;      int dialogX = screenSize.width / 2 - frameSize.width / 2;
&nbsp;      int dialogY = screenSize.height / 2 - frameSize.height / 2;
&nbsp;      progressDialog.setLocation(dialogX, dialogY);
&nbsp;      progressDialog.add(printProgress);
&nbsp;      progressDialog.setAutoRequestFocus(true);
&nbsp;      progressDialog.setAlwaysOnTop(true);
&nbsp;      progressDialog.toFront();
&nbsp;      progressDialog.setVisible(true);
&nbsp;    }
&nbsp;    
&nbsp;    void setValue(int value) {
&nbsp;      progressBar.setValue(value);
&nbsp;      printProgress.setText(&quot;( &quot; + value + &quot; / &quot; + maximum + &quot; )&quot;);
&nbsp;    }
&nbsp;    
&nbsp;    void close() {
&nbsp;      progressDialog.setVisible(false);
&nbsp;    }
&nbsp;    
&nbsp;  }
&nbsp;*/  
&nbsp;  
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2023-02-20 19:41</div>
</div>
</body>
</html>
